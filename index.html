<!DOCTYPE html>

<html lang="ja">
<head>
<link href="favicon-32.png" rel="icon" type="image/png"/>
<link href="icon-180.png" rel="apple-touch-icon"/>
<!-- PWAã£ã½ãä½¿ã†å ´åˆï¼ˆä»»æ„ï¼‰ -->
<link href="icon-192.png" rel="icon" sizes="192x192" type="image/png"/>
<link href="icon-512.png" rel="icon" sizes="512x512" type="image/png"/>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<title>ç²¾ç ” è¦‹ç©ã‚‚ã‚Šï¼ˆå½©ãƒ»å˜é ­æ©Ÿãƒ»å°‘æ•°é ­æ©Ÿï¼‰</title>
<!-- PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰ -->
<script defer="" src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script defer="" src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<!-- PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰ -->
<script defer="" src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script defer="" src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
    :root{
      --border:#333;
      --thin:1px;
      --bg:#fafafa;
      --card:#fff;

      /* === è¿½åŠ ï¼šã‚ªãƒ—ã‚·ãƒ§ãƒ³é¸æŠã®è‰²ï¼ˆæ·¡ã„ï¼‰ === */
      --opt-on-bg:#e6f4ea;   /* ONï¼šæ·¡ã„ã‚°ãƒªãƒ¼ãƒ³ */
      --opt-off-bg:#ffffff; /* OFFï¼šç™½ */
    }

    body{
      font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      margin: 12px;
      color:#111;
      background: var(--bg);
    }

    /* ===== ç”»é¢ï¼šå…¥åŠ›UI ===== */
    .app-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .app-title{
      font-weight:900;
      letter-spacing: .5px;
    }
    .app-sub{
      font-size:12px;
      color:#666;
      margin-top:2px;
    }

    .toolbar{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center;
      margin-bottom:10px;
      position: sticky;
      top: 0;
      z-index: 5;
      background: var(--bg);
      padding: 8px 0;
    }

    .btn{
      border:1px solid #ddd;
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      font-size: 13px;
      cursor:pointer;
    }
    .btn.mini{ padding:6px 10px; font-size:12px; }
    .section-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }

    .btn.primary{
      border-color:#111;
      font-weight:800;
    }

    .card{
      border:1px solid #ddd; border-radius:12px;
      background: var(--card);
      padding:12px; margin-bottom:12px;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    .row{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }

    label{ font-size: 13px; font-weight:700; }
    input, select, textarea{
      font-size: 14px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      flex: 1;
    }
    textarea{ min-height: 70px; resize: vertical; }

    /* === UIèª¿æ•´ï¼ˆåŸºæœ¬æƒ…å ±ãƒ»æ•°é‡å…¥åŠ›ã®ã¯ã¿å‡ºã—å¯¾ç­–ï¼‰ === */
    #notes{
      width: 100%;
      min-height: 110px;
    }
    input.qty{
      width: 100%;
      flex: 0 0 auto;
    }
    /* å¿µã®ãŸã‚ï¼šæ•°é‡æ¬„ã®ã‚³ãƒ³ãƒ†ãƒŠå†…ã§å…¥åŠ›ãŒä¼¸ã³ã™ããªã„ã‚ˆã†ã« */
    .row > div[style*="width:130px"] input,
    .row > div[style*="width:120px"] input{
      width: 100%;
      flex: 0 0 auto;
    }

    .muted{
      font-size: 12px;
      color: #666;
    }

    .opt-head{
      font-weight: 800;
      font-size: 13px;
      margin-bottom: 8px;
      color: #111;
    }

    
    /* ===== ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¦‹å‡ºã—ã®è¦–èªæ€§å‘ä¸Š ===== */
    .opt-panel > summary.opt-head{
      list-style: none;           /* â–¼ãƒãƒ¼ã‚«ãƒ¼éè¡¨ç¤ºï¼ˆSafariå¯¾ç­–ï¼‰ */
      cursor: pointer;
      padding: 10px 12px;
      border-radius: 8px;
      background: #f1f3f5;        /* æ·¡ã„ã‚°ãƒ¬ãƒ¼ï¼ˆä¸»ï¼‰ */
      border: 1px solid #d6dbe0;  /* è–„ã„æ ç·š */
      font-weight: 800;
      margin: 0;                  /* æ—¢å­˜inline styleã®æ„å›³ã‚’CSSã§ã‚‚æ‹…ä¿ */
    }
    /* Safariã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ã‚«ãƒ¼ã‚’æ¶ˆã™ */
    .opt-panel > summary.opt-head::-webkit-details-marker{ display:none; }

    /* é–‹ã„ã¦ã„ã‚‹æ™‚ï¼ˆdetails[open]ï¼‰ */
    .opt-panel[open] > summary.opt-head{
      background: #e9edf2;        /* å°‘ã—ã ã‘æ¿ƒã */
      border-color: #cfd6dd;
    }

    /* hoverï¼ˆPCæ“ä½œæ™‚ã®åˆ†ã‹ã‚Šã‚„ã™ã•ï¼‰ */
    .opt-panel > summary.opt-head:hover{
      background: #e6eaef;
    }

    /* summary å†…ã®ã‚µãƒãƒªãƒ¼æ–‡å­— */
    .opt-panel > summary.opt-head .muted{
      margin-left: 6px;
      font-weight: 600;
      color: #555;
    }

.opt-panel{
      border-top: 1px solid #ddd;
      padding-top: 10px;
    }
    .opt-panel summary{
      cursor: pointer;
      user-select: none;
    }

    .opt-list{
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .opt-row{
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-radius: 8px;
      background: var(--opt-off-bg);
      border: 1px solid #ddd;
      transition: background .2s;
    }
    .opt-row.on{
      background: var(--opt-on-bg);
      border-color: #6ba368;
    }

    .opt-label{
      flex: 1;
      font-size: 13px;
      font-weight: 600;
    }

    .opt-qty{
      width: 80px;
    }

    .switch{
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }
    .switch input{
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider{
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: .3s;
      border-radius: 24px;
    }
    .slider:before{
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }
    .switch input:checked + .slider{
      background:#111;
    }
    .switch input:checked + .slider:before{
      transform: translateX(20px);
    }

    .opt-row.off .opt-label{ color:#222; }
    .opt-row.on  .opt-label{ color:#111; }

    .neg{ color:#b00000; }
    .neg-input{ color:#b00000; }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .toolbar{ gap:6px; }
    }

    @media print{
      html, body{ margin:0; padding:0; background:#fff; }
      /* 1ãƒšãƒ¼ã‚¸ã«åã¾ã‚‹å ´åˆã¯1ãƒšãƒ¼ã‚¸ã€ã¯ã¿å‡ºãŸã‚‰è‡ªå‹•ã§è¤‡æ•°ãƒšãƒ¼ã‚¸ */
      @page{ size: A4; margin: 10mm; }

      .no-print{ display:none !important; }

      .print-area{ margin:0; padding:0; max-width:none; }
      .paper{
        width: 210mm;
        /* â˜…é‡è¦ï¼šå›ºå®š/æœ€å°é«˜ã•ã§å¼·åˆ¶2ãƒšãƒ¼ã‚¸ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ */
        min-height: auto !important;
        height: auto !important;
        padding: 10mm 12mm;
        box-sizing: border-box;
      }

      /* è¡¨ã®è‡ªç„¶æ”¹ãƒšãƒ¼ã‚¸ï¼ˆè¡Œã®é€”ä¸­ã§åˆ‡ã‚‰ãªã„ï¼‹ãƒ˜ãƒƒãƒ€ãƒ¼ç¹°ã‚Šè¿”ã—ï¼‰ */
      table{ page-break-inside: auto; }
      tr{ page-break-inside: avoid; page-break-after: auto; }
      thead{ display: table-header-group; }
      tfoot{ display: table-footer-group; }
    }

    /* ===== PDFç”Ÿæˆç”¨ï¼šå°åˆ·ã¨åŒã˜æ”¹ãƒšãƒ¼ã‚¸æŒ™å‹•ã«å¯„ã›ã‚‹ ===== */
    body.pdf-mode{
      margin:0;
      background:#fff;
    }
    body.pdf-mode .no-print{ display:none !important; }
    body.pdf-mode .print-area{ margin:0; padding:0; max-width:none; }
    body.pdf-mode .paper{
      width: 210mm;
      min-height: auto !important;
      height: auto !important;
      padding: 10mm 12mm;
      box-sizing: border-box;
      background:#fff;
    }
    body.pdf-mode table{ page-break-inside: auto; }
    body.pdf-mode tr{ page-break-inside: avoid; page-break-after: auto; }
    body.pdf-mode thead{ display: table-header-group; }
    body.pdf-mode tfoot{ display: table-footer-group; }

    .print-area{
      max-width: 210mm;
      margin: 0 auto;
    }
    .paper{
      width: 210mm;
      min-height: 297mm;
      padding: 10mm 12mm;
      box-sizing: border-box;
      background:#fff;
    }

    .header{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      align-items:center;
      margin-bottom: 4mm;
    }
    .no{
      font-size: 12px;
      font-weight: 700;
    }
    .title{
      text-align:center;
      font-size: 22px;
      font-weight: 800;
      letter-spacing: 6px;
    }
    .date{
      text-align:right;
      font-size: 12px;
      font-weight: 700;
    }

    .top-block{
      margin-top: 4mm;
      display:grid;
      grid-template-columns: 1fr 68mm;
      gap: 10mm;
      align-items:start;
    }

    .to{ padding-top: 2mm; }
    .to-name{
      font-size: 21px;
      font-weight: 800;
      display:inline-block;
      padding-bottom: 2mm;
      border-bottom: var(--thin) solid var(--border);
      min-width: 115mm;
    }

    .issuer{
      border: var(--thin) solid var(--border);
      padding: 3mm 3mm 3mm 2mm;
      box-sizing: border-box;
      font-size: 11px;
      position: relative;
    }
    .issuer-text{
      margin-right: 22mm;
    }

    .issuer-name{
      font-weight: 900;
      font-size: 13.5px;
      margin-bottom: 1.5mm;
    }
    .issuer .rowline{
      display:flex;
      gap: 3px;
      white-space: nowrap;
      margin: 0.8mm 0;
    }
    .issuer .k{ width: 10mm; font-weight:700; }
    .issuer .v{ flex: 1; white-space: normal; }

    .issuer .tantou{
      margin-top: 3mm;
      border-top: 1px dashed #777;
      padding-top: 2mm;
      font-weight: 700;
    }

    .inkan{
      position:absolute;
      right: 5mm;
      top: 5mm;
      width: 18mm;
      height: auto;
      opacity: 0.95;
    }

    .greeting{
      margin-top: 4mm;
      font-size: 12px;
      font-weight: 700;
    }

    .summary{
      margin-top: 2mm;
      display:grid;
      grid-template-columns: 1fr 1fr;
      align-items:end;
      border-top: var(--thin) solid var(--border);
      border-bottom: var(--thin) solid var(--border);
      padding: 2.5mm 0;
    }
    .sum-label{
      font-size: 14px;
      font-weight: 900;
    }
    .sum-amount{
      text-align:right;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: 1px;
      font-variant-numeric: tabular-nums;
    }

    .cond{
      margin-top: 4mm;
      border: var(--thin) solid var(--border);
      border-collapse: collapse;
      width:100%;
      font-size: 12px;
    }
    .cond td{
      border: var(--thin) solid var(--border);
      padding: 2.2mm;
      vertical-align: middle;
    }
    .cond .k{ width: 18mm; font-weight: 800; background:#f7f7f7; }
    .cond .v{ width: 60mm; }
    .cond .k2{ width: 22mm; font-weight: 800; background:#f7f7f7; }

    /* â˜…è¿½åŠ ï¼šå—æ¸¡å ´æ‰€ã ã‘æ”¹è¡Œã‚’åŠ¹ã‹ã›ã‚‹ï¼ˆzipâ†’ä½æ‰€ã‚’2è¡Œè¡¨ç¤ºã™ã‚‹ãŸã‚ï¼‰ */
    #outPlace{ white-space: pre-line; }

    .items{
      margin-top: 4mm;
      border: var(--thin) solid var(--border);
      border-collapse: collapse;
      width:100%;
      font-size: 12px;
    }
    .items th, .items td{
      border: var(--thin) solid var(--border);
      padding: 2.1mm;
    }
    .items th{
      background:#f7f7f7;
      font-weight: 900;
    }
    .items .c-qty{ width: 12mm; text-align:center; }
    .items .c-unit{ width: 28mm; text-align:right; }
    .items .c-amt{ width: 28mm; text-align:right; }
    .items .desc{ width:auto; }

    .bottom{
      margin-top: 4mm;
      display:grid;
      grid-template-columns: 1fr 70mm;
      gap: 6mm;
      align-items:start;
    }
    .note-box{
      border: var(--thin) solid var(--border);
      min-height: 36mm;
      padding: 2.5mm;
      box-sizing:border-box;
      font-size: 12px;
    }
    .totals{
      border: var(--thin) solid var(--border);
      border-collapse: collapse;
      width:100%;
      font-size: 12px;
    }
    .totals td{
      border: var(--thin) solid var(--border);
      padding: 2.2mm;
    }
    .totals .k{
      width: 18mm;
      font-weight: 800;
      background:#f7f7f7;
      text-align:center;
    }
    .totals .v{
      text-align:right;
      font-variant-numeric: tabular-nums;
    }

    .caution{
      margin-top: 4mm;
      font-size: 11px;
    }
    .caution .head{
      font-weight: 800;
      margin-bottom: 2mm;
    }
    .caution ul{
      margin: 0;
      padding-left: 18px;
    }
    .caution li{
      margin-bottom: 1mm;
    }
  </style>
</head>
<body>
<div class="no-print">
<div class="app-head">
<div>
<div class="app-title">ç²¾ç ” è¦‹ç©ã‚‚ã‚Šï¼ˆå½©ãƒ»å˜é ­æ©Ÿãƒ»å°‘æ•°é ­æ©Ÿï¼‰</div>
<div class="app-sub">TEST-7_1 - å½©çµ±åˆç‰ˆ</div>
</div>
</div>
<div class="toolbar">
<button class="btn primary" onclick="downloadPDF()">ğŸ’¾ ä¿å­˜ï¼ˆPDFï¼‰</button>
<button class="btn" onclick="printPage()">ğŸ–¨ï¸ å°åˆ·</button>
<button class="btn" onclick="regenQuoteNo()">ğŸ”„ è¦‹ç©ç•ªå· å†ç”Ÿæˆ</button>
<button class="btn" onclick="resetAll()">ğŸ—‘ï¸ ãƒªã‚»ãƒƒãƒˆ</button>
</div>
<div class="no-print">
<div class="card">
<div class="section-head"><div class="opt-head">åŸºæœ¬æƒ…å ±</div><button class="btn mini" onclick="resetBasicInfoSection()" type="button">ã“ã®æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆ</button></div>
<div class="grid">
<div>
<label>è¦‹ç©ç•ªå·ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰</label>
<input id="quoteNo" oninput="quoteNoManuallyEdited=true; applyAndRender()" placeholder="ä¾‹ï¼šDH-TMAR-K1502C-20260114-153045" type="text"/>
<div class="muted" style="margin-top:6px">
              å½¢å¼ï¼šæ‹…å½“è€…ã‚¤ãƒ‹ã‚·ãƒ£ãƒ«-ãƒ¢ãƒ‡ãƒ«å-æ—¥ä»˜-æ™‚åˆ»ï¼ˆæ‰‹å…¥åŠ›å¯ï¼‰
            </div>
</div>
<div>
<label>ç™ºè¡Œæ—¥</label>
<input id="issueDate" onchange="onIssueDateChange()" type="date"/>
</div>
</div>
<div class="row" style="margin-top:10px">
<div style="flex:1">
<label>å®›åï¼ˆä¼šç¤¾åç­‰ï¼‰</label>
<input id="toBase" oninput="applyAndRender()" placeholder="ä¾‹ï¼šæ ªå¼ä¼šç¤¾â—‹â—‹" type="text"/>
</div>
<div style="width:120px">
<label>æ•¬ç§°</label>
<select id="toHonorific" onchange="applyAndRender()">
<option value="å¾¡ä¸­">å¾¡ä¸­</option>
<option value="æ§˜">æ§˜</option>
</select>
</div>
</div>
<div class="row" style="margin-top:10px">
<div style="flex:1">
<label>æ‹…å½“è€…</label>
<select id="tantouSelect" onchange="onTantouChange()">
<option value="">é¸æŠã—ã¦ãã ã•ã„</option>
<option value="æ¨‹å£å¤§">æ¨‹å£å¤§</option>
<option value="å·½éš†å……">å·½éš†å……</option>
<option value="ä¸‰è°·å‰›å²">ä¸‰è°·å‰›å²</option>
<option value="å±±å´è¿…äºº">å±±å´è¿…äºº</option>
<option value="èˆ‡é‚£åŸæ˜­å½¦">èˆ‡é‚£åŸæ˜­å½¦</option>
<option value="å…«ç”°é›…éš†">å…«ç”°é›…éš†</option>
</select>
</div>
</div>
<div class="row" style="margin-top:10px">
<div style="flex:1">
<label>ç´æœŸ</label>
<input id="delivery" oninput="applyAndRender()" placeholder="ä¾‹ï¼šå—æ³¨å¾Œ ç´„3ã‚«æœˆ" type="text"/>
</div>
</div>
<!-- â˜…æ”¹ä¿®ï¼šå—æ¸¡å ´æ‰€ï¼ä½æ‰€å…¥åŠ›UIï¼ˆéƒµä¾¿ç•ªå·â†’è‡ªå‹•å…¥åŠ›ï¼‹ç•ªåœ°æ‰‹å…¥åŠ›ï¼‰ -->
<div class="row" style="margin-top:10px">
<!-- éƒµä¾¿ç•ªå·ï¼šå¹…ã‚’éƒ½é“åºœçœŒæ¬„ã¨åŒç­‰ï¼ˆ1ã‚«ãƒ©ãƒ ï¼‰ã«ã™ã‚‹ -->
<div style="flex:1; min-width:0">
<label>å—æ¸¡å ´æ‰€ï¼ˆéƒµä¾¿ç•ªå·ï¼‰</label>
<div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center">
<input id="zip" placeholder="ä¾‹ï¼š573-0102" style="flex:1; min-width:180px" type="text" onkeydown="if(event.key==='Enter'){event.preventDefault();lookupZip();}"/>
<button class="btn" onclick="lookupZip()" style="white-space:nowrap; font-size:14px; padding:10px 12px" type="button">ä½æ‰€è‡ªå‹•å…¥åŠ›</button>
</div>
<div class="muted" style="margin-top:4px">â€»ç”ºåã¾ã§è‡ªå‹•å…¥åŠ›ã€‚ç•ªåœ°ãƒ»å»ºç‰©åã¯ä¸‹ã§æ‰‹å…¥åŠ›ã€‚Enterã‚­ãƒ¼ã§ã‚‚æ¤œç´¢ã§ãã¾ã™ã€‚</div>
</div>
<!-- å³å´ã¯ç©ºã‘ã¦ã€éƒµä¾¿ç•ªå·æ¬„ãŒåºƒãŒã‚Šéããªã„ã‚ˆã†ã«ã™ã‚‹ -->
<div style="flex:1"></div>
</div>
<div class="row" style="margin-top:6px">
<div style="flex:1">
<label>éƒ½é“åºœçœŒ</label>
<input id="pref" oninput="applyAndRender()" placeholder="ä¾‹ï¼šå¤§é˜ªåºœ" type="text"/>
</div>
<div style="flex:1">
<label>å¸‚åŒºç”ºæ‘</label>
<input id="city" oninput="applyAndRender()" placeholder="ä¾‹ï¼šæšæ–¹å¸‚" type="text"/>
</div>
</div>
<div class="row" style="margin-top:6px">
<div style="flex:1">
<label>ç”ºå</label>
<input id="town" oninput="applyAndRender()" placeholder="ä¾‹ï¼šé•·å°¾å®¶å…·ç”º" type="text"/>
</div>
<div style="flex:1">
<label>ç•ªåœ°ãƒ»å»ºç‰©åï¼ˆæ‰‹å…¥åŠ›ï¼‰</label>
<input id="addr2" oninput="applyAndRender()" placeholder="ä¾‹ï¼š3-12-3 â—‹â—‹ãƒ“ãƒ«2F" type="text"/>
</div>
</div>
<div class="row" style="margin-top:10px">
<div style="flex:1">
<label>æ”¯æ‰•æ¡ä»¶</label>
<input id="payment" oninput="applyAndRender()" placeholder="ä¾‹ï¼šç´å…¥æ™‚ ç¾é‡‘ä¸€æ‹¬æ‰•ã„" type="text"/>
</div>
<div style="flex:1">
<label>è¦‹ç©æœ‰åŠ¹æœŸé™</label>
<input id="valid" oninput="applyAndRender()" placeholder="ä¾‹ï¼š30æ—¥" type="text"/>
</div>
</div>
<div class="row" style="margin-top:10px">
<div style="flex:1">
<label>å‚™è€ƒï¼ˆè‡ªç”±è¨˜å…¥ï¼‰</label>
<textarea id="notes" oninput="applyAndRender()" placeholder="ä¾‹ï¼šæœ¬è¦‹ç©æ›¸ã®æœ‰åŠ¹æœŸé™ã¯30æ—¥ã§ã™ã€‚æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚ŒãŸå ´åˆã¯ã€å†è¦‹ç©ã¨ãªã‚Šã¾ã™ã€‚"></textarea>
</div>
</div>
</div>
<div class="card">
<div class="section-head"><div class="opt-head">åˆºç¹æ©Ÿæœ¬ä½“</div><button class="btn mini" onclick="resetMachineSection()" type="button">æœ¬ä½“ã‚’ãƒªã‚»ãƒƒãƒˆ</button></div>
<div class="row">
<div style="flex:1">
<label>åŒºåˆ†</label>
<select id="machineCategory" style="width:100%"><option value="sai">å½©ï¼ˆSAIï¼‰</option>
<option selected="" value="single">å˜é ­æ©Ÿ</option>
<option value="few">å°‘æ•°é ­æ©Ÿ</option>
</select>
</div>
<div style="flex:1">
<label>æ©Ÿç¨®å</label>
<select id="machineModel" style="width:100%"></select>
</div>
<div style="width:140px">
<label>é‡æ•°</label>
<select id="machineNeedles" style="width:100%"></select>
</div>
<div style="width:140px">
<label>é ­æ•°</label>
<select id="machineHeads" style="width:100%"></select>
</div>
<div style="width:170px">
<label>åˆºç¹ç¯„å›²</label>
<select id="machineField" style="width:100%"></select>
</div>
</div>
<div class="row" style="margin-top:10px">
<div style="flex:1">
<div class="muted">å‹å¼ï¼ˆè‡ªå‹•ï¼‰</div>
<div id="machineFullOut" style="font-weight:800">æœªé¸æŠ</div>
<div class="muted" style="margin-top:4px">è¦‹ç©ç•ªå·ã«å…¥ã‚Œã‚‹ãƒ¢ãƒ‡ãƒ«åï¼š<span id="machineKeyOut">--</span></div>
</div>
<div style="width:210px">
<label>æœ¬ä½“å˜ä¾¡ï¼ˆç¨åˆ¥ï¼‰</label>
<input id="baseUnitPrice" min="0" placeholder="ä¾¡æ ¼ãƒã‚¹ã‚¿ã‹ã‚‰è‡ªå‹•" step="1000" type="number"/>
</div>
<div style="width:130px">
<label>æ•°é‡</label>
<input class="qty" id="baseQty" min="1" oninput="applyAndRender()" step="1" type="number" value="1"/>
</div>
</div>
<div class="opt-head" id="shippingTitle" style="margin-top:14px">é‹é€æ®ä»˜ãƒ»ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—åŠã³è¬›ç¿’è²»ç”¨</div>
<div class="row">
<div style="flex:1">
<label>åœ°åŸŸ</label>
<select id="region" onchange="applyAndRender()">
<!-- JavaScriptã§å‹•çš„ã«é¸æŠè‚¢ã‚’è¨­å®š -->
</select>
</div>
<div style="width:210px">
<label>ãã®ä»–ã®å ´åˆã®é‡‘é¡ï¼ˆç¨åˆ¥ï¼‰</label>
<input disabled="" id="regionOtherPrice" min="0" oninput="applyAndRender()" placeholder="ä¾‹ï¼š160000" step="1000" type="number"/>
</div>
</div>
<div class="muted" style="margin-top:10px">
          å½©é¸æŠæ™‚ï¼šã€Œå½©ï¼šã€ä»˜ãã®åœ°åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚å˜é ­æ©Ÿï¼šã€Œå˜é ­æ©Ÿï¼šã€ä»˜ãã®åœ°åŸŸã‚’é¸æŠã€‚å°‘æ•°é ­æ©Ÿï¼šã€Œãã®ä»–ï¼ˆæ‰‹å…¥åŠ›ï¼‰ã€ã‚’åŸºæœ¬ã¨ã—ã¾ã™ã€‚
        </div>
<details class="opt-panel" style="margin-top:14px">
<summary class="opt-head" style="margin:0">ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆæ•°é‡ã‚’å…¨ã¦å¤‰æ›´å¯ï¼‰ <span class="muted" id="optSummary"></span></summary>
<div class="opt-list" id="optList" style="margin-top:10px"></div>
</details>
</div>
<!-- === è¿½åŠ ï¼šåˆºç¹æ ï¼ˆTFA/TFA2ï¼‰ === -->
<div class="card" id="cardTFA">
<div class="section-head"><div class="opt-head">åˆºç¹æ ï¼ˆTFA / TFA2ï¼‰</div><button class="btn mini" onclick="resetTFASection()" type="button">æ ã‚’ãƒªã‚»ãƒƒãƒˆ</button></div>
<details class="opt-panel" id="tfaPanel">
<summary class="opt-head" style="margin:0">TFAæ ï¼ˆã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‹ãï¼šæ©Ÿç¨®ãƒ»åˆºç¹ç¯„å›²ã§å€™è£œã‚’è‡ªå‹•è¡¨ç¤ºï¼‰ <span class="muted" id="tfaSummary"></span></summary>
<div class="opt-list" id="tfaList" style="margin-top:10px"></div>
<div class="muted" style="font-size:12px; margin-top:8px; line-height:1.5">
            ãƒ»ä¾¡æ ¼æœªè¨­å®šã®æ ã¯ã€Œå˜ä¾¡ã€æ¬„ã«æ‰‹å…¥åŠ›ã§ãã¾ã™ï¼ˆè¦‹ç©æ™‚ã®æš«å®šé‹ç”¨ï¼‰
          </div>
</details>
</div>
<!-- === è¿½åŠ ï¼šåˆºç¹ã‚½ãƒ•ãƒˆï¼ˆDGï¼‰ === -->
<div class="card" id="cardDG">
<div class="section-head"><div class="opt-head">åˆºç¹ã‚½ãƒ•ãƒˆï¼ˆDGï¼‰</div><button class="btn mini" onclick="resetSoftwareSection()" type="button">åˆºç¹ã‚½ãƒ•ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ</button></div>
<div class="row">
<div style="flex:1">
<label>DGã‚°ãƒ¬ãƒ¼ãƒ‰</label>
<select id="dgGrade" style="width:100%"></select>
<div class="muted" style="margin-top:6px">â€» DG-Sã¯åˆ¥æ æ‰±ã„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ãƒ•ã‚©ãƒ³ãƒˆã¯é¸æŠä¸å¯ï¼‰</div>
</div>
<div style="width:130px">
<label>æ•°é‡</label>
<input class="qty" id="dgQty" min="1" oninput="applyAndRender()" step="1" type="number" value="1"/>
</div>
</div>
<details class="opt-panel" id="dgOptPanel" style="margin-top:14px">
<summary class="opt-head" style="margin:0">DGã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆã‚°ãƒ¬ãƒ¼ãƒ‰é€£å‹•ï¼‰ <span class="muted" id="dgOptSummary"></span></summary>
<div class="opt-row off" id="dgopt_row_DG_LESSON" style="margin-top:10px">
<label class="switch">
<input id="dgopt_DG_LESSON" onchange="toggleDGItem('dgopt','DG_LESSON')" type="checkbox"/>
<span class="slider"></span>
</label>
<div class="opt-label">DGè¬›ç¿’è²»ç”¨</div>
<div style="margin-left:auto; display:flex; gap:10px; align-items:center">
<span style="color:#666; font-size:12px;">é‡‘é¡</span>
<input id="dgopt_DG_LESSON_price" min="0" oninput="applyAndRender()" step="1" style="width:130px; text-align:right" type="number" value="0">
<input class="opt-qty" id="dgopt_DG_LESSON_qty" min="1" oninput="applyAndRender()" step="1" type="number" value="1"/>
</input></div>
</div>
<div class="opt-list" id="dgOptList" style="margin-top:10px"></div>
</details>
<details class="opt-panel" id="dgFontPanel" style="margin-top:14px">
<summary class="opt-head" style="margin:0">DGãƒ•ã‚©ãƒ³ãƒˆï¼ˆã‚°ãƒ¬ãƒ¼ãƒ‰é€£å‹•ï¼‰ <span class="muted" id="dgFontSummary"></span></summary>
<div class="opt-list" id="dgFontList" style="margin-top:10px"></div>
</details>
<details class="opt-panel" id="dgLanPanel" style="margin-top:14px">
<summary class="opt-head" style="margin:0">LANåˆºç¹æ©Ÿãƒ©ã‚¤ã‚»ãƒ³ã‚¹ <span class="muted" id="dgLanSummary"></span></summary>
<div class="opt-list" id="dgLanList" style="margin-top:10px"></div>
</details>
</div>
<div class="card">
<div class="opt-head">ã‚¹ãƒãƒ›ï¼ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã€ŒPDFåŒ– â†’ é€ä¿¡ã€ã™ã‚‹æ‰‹é †ï¼ˆç¾å®Ÿçš„ãªé‹ç”¨ï¼‰</div>
<div class="muted">
        1) ã¾ãšã€Œä¿å­˜ã€ã‚’æŠ¼ã™ â†’ å°åˆ·ç”»é¢ã§ã€ŒPDFã«ä¿å­˜ã€ï¼ˆã“ã‚ŒãŒä¸€ç•ªãã‚Œã„ã«å‡ºã¾ã™ï¼‰<br/>
        2) iPhone/iPadï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã§å…±æœ‰ãƒœã‚¿ãƒ³ â†’ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã€ã¾ãŸã¯ã€Œãƒ¡ãƒ¼ãƒ«/LINEç­‰ã¸é€ä¿¡ã€<br/>
        3) Androidï¼šå°åˆ·å…ˆã‚’ã€ŒPDFã«ä¿å­˜ã€â†’ å…±æœ‰<br/>
        â€» ãƒ–ãƒ©ã‚¦ã‚¶ãŒSafari/Chromeã§ã‚‚æ¦‚ã­åŒã˜ã§ã™ã€‚
      </div>
</div>
</div>
</div>
<!-- å°åˆ·å¯¾è±¡ -->
<div class="print-area">
<div class="paper" id="paper">
<div class="header">
<div class="no" id="outNo">No.--MODEL----------</div>
<div class="title">å¾¡ è¦‹ ç© æ›¸</div>
<div class="date" id="outDate">ä»¤å’Œ -- å¹´ -- æœˆ -- æ—¥</div>
</div>
<div class="top-block">
<div class="to">
<div class="to-name" id="outTo">æ ªå¼ä¼šç¤¾ã€€ï¼¿ï¼¿ï¼¿ï¼¿ã€€å¾¡ä¸­</div>
</div>
<div class="issuer">
<img alt="ä¼šç¤¾å°" class="inkan" src="inkan.png"/>
<div class="issuer-text">
<div class="issuer-name">æ ªå¼ä¼šç¤¾ ç²¾ç ”</div>
<div class="rowline"><div class="k">ã€’</div><div class="v">573-0102</div></div>
<div class="rowline"><div class="k"></div><div class="v">å¤§é˜ªåºœæšæ–¹å¸‚é•·å°¾å®¶å…·ç”º3-12-3</div></div>
<div class="rowline"><div class="k">TEL</div><div class="v">072-856-8253</div></div>
<div class="rowline"><div class="k">FAX</div><div class="v">072-856-8254</div></div>
<div class="tantou" id="outTantou">æ‹…å½“è€…ã€€ï¼¿ï¼¿ï¼¿ï¼¿</div>
</div>
</div>
</div>
<div class="greeting">ä¸‹è¨˜ã®é€šã‚Šã€å¾¡è¦‹ç©ç”³ã—ä¸Šã’ã¾ã™ã€‚</div>
<div class="summary">
<div class="sum-label">ç·é‡‘é¡</div>
<div class="sum-amount" id="outGrand">ï¿¥0 -</div>
</div>
<table class="cond">
<tr>
<td class="k">ç´æœŸ</td><td class="v" id="outDelivery">å—æ³¨å¾Œ ç´„3ã‚«æœˆ</td>
<td class="k2">å—æ¸¡å ´æ‰€</td><td id="outPlace">å¾¡ç¤¾ã”æŒ‡å®šå ´æ‰€</td>
</tr>
<tr>
<td class="k">æ”¯æ‰•æ¡ä»¶</td><td class="v" id="outPayment">ç´å…¥æ™‚ ç¾é‡‘ä¸€æ‹¬æ‰•ã„</td>
<td class="k2">è¦‹ç©æœ‰åŠ¹æœŸé™</td><td id="outValid">30æ—¥</td>
</tr>
</table>
<table class="items">
<thead>
<tr>
<th class="desc">å“ååŠã³ä»•æ§˜</th>
<th class="c-qty">æ•°é‡</th>
<th class="c-unit">å˜ä¾¡</th>
<th class="c-amt">é‡‘é¡</th>
</tr>
</thead>
<tbody id="outItems"></tbody>
</table>
<div class="bottom">
<div class="note-box" id="outNotes"></div>
<table class="totals">
<tr><td class="k">å°è¨ˆ</td><td class="v" id="outSub">0</td></tr>
<tr><td class="k">æ¶ˆè²»ç¨</td><td class="v" id="outTax">0</td></tr>
<tr><td class="k">åˆè¨ˆ</td><td class="v" id="outTotal">0</td></tr>
</table>
</div>
<div class="caution">
<div class="head">ã€æ³¨æ„äº‹é …ã€‘</div>
<ul>
<li>è£½å“ä¿è¨¼æœŸé–“ã¯ç´å…¥æ—¥ã‚ˆã‚Š1å¹´é–“ã§ã™ã€‚</li>
<li>å˜é ­æ©Ÿã‚’ã”æ¤œè¨ã®ãŠå®¢æ§˜ã«ã¯ã€ä¿è¨¼å»¶é•·ã‚µãƒ¼ãƒ“ã‚¹ã€Œã‚ã‚“ã—ã‚“å®šé¡ã‚µãƒãƒ¼ãƒˆã€ã®åŒæ™‚åŠ å…¥ã‚’ãŠå‹§ã‚ã—ã¦ãŠã‚Šã¾ã™ã€‚</li>
</ul>
</div>
</div>
</div>
<script>
  // =========================================================
  // è¦‹ç©ç•ªå·ï¼šæ‹…å½“è€…ã‚¤ãƒ‹ã‚·ãƒ£ãƒ« - æ©Ÿç¨® - YYYYMMDD-HHMMSS
  // ä¾‹ï¼‰DH-TMAR-K1502C-20260114-153045
  // =========================================================
  const DEFAULT_MACHINE_CODE = 'MODEL';

  // æ‹…å½“è€… â†’ ã‚¤ãƒ‹ã‚·ãƒ£ãƒ«ï¼ˆé‹ç”¨ã§å›ºå®šæ¨å¥¨ï¼‰
  const TANTOU_CODE_MAP = {
    'æ¨‹å£å¤§': 'DH',
    'å·½éš†å……': 'TT',
    'ä¸‰è°·å‰›å²': 'TM',
    'å±±å´è¿…äºº': 'HY',
    'èˆ‡é‚£åŸæ˜­å½¦': 'AY',
    'å…«ç”°é›…éš†': 'MH'
  };

  // è¦‹ç©ç•ªå·ã‚’æ‰‹å‹•ç·¨é›†ã—ãŸã‚‰ã€ä»¥å¾Œã¯æ‹…å½“è€…å¤‰æ›´ã§ä¸Šæ›¸ãã—ãªã„
  let quoteNoManuallyEdited = false;

  function pad2(n){ return String(n).padStart(2,'0'); }

  function yyyymmddNow(d){
    return `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}`;
  }
  function hhmmssNow(d){
    return `${pad2(d.getHours())}${pad2(d.getMinutes())}${pad2(d.getSeconds())}`;
  }

  function getTantouCode(){
    const name = document.getElementById('tantouSelect').value || '';
    return TANTOU_CODE_MAP[name] || '--';
  }

  function generateQuoteNoNow(){
    const d = new Date();
    const tantou = getTantouCode();
    const model = getMachineCodeForQuoteNo();
    return `${tantou}-${model}-${yyyymmddNow(d)}-${hhmmssNow(d)}`;
  }

  function regenQuoteNo(){
    const q = document.getElementById('quoteNo');
    q.value = generateQuoteNoNow();
    quoteNoManuallyEdited = false; // å†ç”Ÿæˆã—ãŸã‚‰ã€Œè‡ªå‹•ã€ã«æˆ»ã™
    applyAndRender();
  }

  // æ‹…å½“è€…å¤‰æ›´æ™‚ï¼šè¦‹ç©ç•ªå·ãŒæœªç·¨é›†ãªã‚‰è‡ªå‹•æ›´æ–°
  function onTantouChange(){
    const q = document.getElementById('quoteNo');
    if(!quoteNoManuallyEdited){
      q.value = generateQuoteNoNow();
    }
    applyAndRender();
  }

  // =========================================================
  // â˜…è¿½åŠ ï¼šzipcloudï¼ˆéƒµä¾¿ç•ªå·â†’ä½æ‰€è‡ªå‹•å…¥åŠ›ï¼‰
  // =========================================================
  function normalizeZip(zip){
    return (zip || '').trim().replace(/[^\d]/g, '');
  }

  function lookupZip(){
    const raw = document.getElementById('zip').value;
    const zip = normalizeZip(raw);

    if(!zip){
      alert('éƒµä¾¿ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    if(zip.length !== 7){
      alert('éƒµä¾¿ç•ªå·ã¯7æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š5730102 / 573-0102ï¼‰');
      return;
    }

    fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${zip}`)
      .then(res => res.json())
      .then(data => {
        if(data.status !== 200 || !data.results || !data.results[0]){
          alert('ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
          return;
        }
        const r = data.results[0];
        document.getElementById('pref').value = r.address1 || '';
        document.getElementById('city').value = r.address2 || '';
        document.getElementById('town').value = r.address3 || '';
        applyAndRender();
      })
      .catch(() => {
        alert('ä½æ‰€æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç­‰ï¼‰');
      });
  }

  function buildPlaceText(){
    const zipRaw = document.getElementById('zip').value.trim();
    const zip = normalizeZip(zipRaw);
    const pref = document.getElementById('pref').value.trim();
    const city = document.getElementById('city').value.trim();
    const town = document.getElementById('town').value.trim();
    const addr2 = document.getElementById('addr2').value.trim();

    // ä½•ã‚‚å…¥ã£ã¦ãªã‘ã‚Œã°å¾“æ¥ã©ãŠã‚Š
    if(!zip && !pref && !city && !town && !addr2){
      return 'å¾¡ç¤¾ã”æŒ‡å®šå ´æ‰€';
    }

    const zipDisp = zip ? `ã€’${zip.slice(0,3)}-${zip.slice(3)}` : '';
    const addrLine = `${pref}${city}${town}${addr2}`.trim();

    if(zipDisp && addrLine) return `${zipDisp}\n${addrLine}`;
    return (zipDisp || addrLine || 'å¾¡ç¤¾ã”æŒ‡å®šå ´æ‰€');
  }

  // =========================================================
  // â˜…è¿½åŠ ï¼šãƒ˜ãƒƒãƒ€ãƒ¼ã®ã€Œä¿å­˜ã€ã€Œå°åˆ·ã€
  // ä¿å­˜ï¼šå°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãï¼ˆPDFä¿å­˜å‰æï¼‰ï¼‹ title ã‚’ä¸€æ™‚çš„ã«è¦‹ç©ç•ªå·å…¥ã‚Šã¸
  // å°åˆ·ï¼šé€šå¸¸å°åˆ·
  // =========================================================
  function makeSafeFilePart(str){
    return (str || '')
      .replace(/\s+/g,' ')
      .trim()
      .replace(/[\\/:*?"<>|]/g,'-')
      .slice(0, 50);
  }

  // â˜…è¿½åŠ ï¼šä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆè¦‹ç©ç•ªå·ï¼‹æ—¥æ™‚ï¼‹é¡§å®¢åï¼‰
  function getCustomerNameForFile(){
    const base = (document.getElementById('toBase').value || '').trim();
    if(!base) return '';
    // æœ«å°¾ã®æ•¬ç§°ãŒæ··ã–ã£ã¦ã„ã‚‹å ´åˆã«å‚™ãˆã¦é™¤å»
    return base.replace(/(å¾¡ä¸­|æ§˜)\s*$/,'').trim();
  }

  function buildSaveFileName(){
    const quote = (document.getElementById('quoteNo').value || '').trim() || `--${getMachineCodeForQuoteNo() || DEFAULT_MACHINE_CODE}----------`;
    const customer = getCustomerNameForFile();
    const parts = [quote, customer].filter(p => (p || '').trim() !== '');
    return makeSafeFilePart(parts.join('_'));
  }


  
  async function downloadPDF(){
    // html2canvas + jsPDF ã§PDFã‚’ç”Ÿæˆï¼ˆé•·æ–‡ã¯è‡ªå‹•ã§è¤‡æ•°ãƒšãƒ¼ã‚¸ï¼‰
    if(!window.html2canvas || !window.jspdf){
      alert('PDFç”Ÿæˆï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰ã¯ãƒãƒƒãƒˆæ¥ç¶šãŒå¿…è¦ã§ã™ã€‚\nã€Œå°åˆ·ã€ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
      return;
    }

    applyAndRender();

    // â˜…PDFç”Ÿæˆæ™‚ã‚‚ã€Œå°åˆ·ã¨åŒã˜ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ/æ”¹ãƒšãƒ¼ã‚¸ã€ã«å¯„ã›ã‚‹
    document.body.classList.add('pdf-mode');

    try{
      // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåæ˜ ã‚’1ãƒ•ãƒ¬ãƒ¼ãƒ å¾…ã¤
      await new Promise(requestAnimationFrame);

      const el = document.getElementById('paper');
      const canvas = await window.html2canvas(el, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff'
      });
      const imgData = canvas.toDataURL('image/png');

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

      const pageW = 210;
      const pageH = 297;

      const imgW = pageW;
      const imgH = canvas.height * (imgW / canvas.width);

      if(imgH <= pageH){
        pdf.addImage(imgData, 'PNG', 0, 0, imgW, imgH);
      }else{
        // 1æšã®é•·ã„ç”»åƒã‚’A4é«˜ã•ã”ã¨ã«åˆ‡ã‚Šå‡ºã—ã¦ãƒšãƒ¼ã‚¸è¿½åŠ 
        let y = 0;
        let remaining = imgH;
        while(remaining > 0){
          pdf.addImage(imgData, 'PNG', 0, -y, imgW, imgH);
          remaining -= pageH;
          y += pageH;
          if(remaining > 0) pdf.addPage();
        }
      }

      pdf.save(buildSaveFileName() + '.pdf');
    }finally{
      document.body.classList.remove('pdf-mode');
    }
  }


  function printPage(){
    applyAndRender();
    window.print();
  }

  // ====== æ©Ÿç¨®é¸æŠãƒ­ã‚¸ãƒƒã‚¯ ======

  // å˜é ­æ©Ÿãƒã‚¹ã‚¿ï¼ˆã‚·ãƒªãƒ¼ã‚ºå›ºå®šï¼‹é‡æ•°ã®ã¿é¸æŠã€‚é ­æ•°=01ã€ç¯„å›²=360Ã—500 å›ºå®šï¼‰
  const SINGLE_SERIES = [
    { id:'TMEZ-S',  label:'TMEZ-S',  needles:[9,12,15], displayName:'ã‚¿ã‚¸ãƒ 1é ­å¼åˆºç¹æ©Ÿ i-TM/DCP æ­è¼‰ãƒ¢ãƒ‡ãƒ«' },
    { id:'TMBR2-S', label:'TMBR2-S', needles:[6,12,15,18], displayName:'ã‚¿ã‚¸ãƒ 1é ­å¼åˆºç¹æ©Ÿ DCPæ­è¼‰ãƒ¢ãƒ‡ãƒ«' },
    { id:'TMBP2-S', label:'TMBP2-S', needles:[6,12,15], displayName:'ã‚¿ã‚¸ãƒ 1é ­å¼åˆºç¹æ©Ÿ æ¨™æº–ãƒ¢ãƒ‡ãƒ«' },
  ];

  // å½©ï¼ˆSAIï¼‰ãƒã‚¹ã‚¿ï¼ˆå›ºå®šï¼‰
  const SAI_MODELS = [
    { id:'MDP-S0801C', label:'MDP-S0801C', displayName:'TAJIMAå½© ï¼ˆSAIï¼‰ ã‚¿ã‚¸ãƒ1é ­å¼8è‰²åˆºç¹æ©Ÿ' , full:'MDP-S0801C(200x300)S' }
  ];

  // å½©ï¼ˆSAIï¼‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆä¾¡æ ¼è¡¨PDFã«åŸºã¥ãï¼‰
  const SAI_OPTIONS = [
    { id:'sai_stand', name:'è„šã‚¹ã‚¿ãƒ³ãƒ‰ï¼šMDP-SC', price:137000 },
    { id:'sai_wide_cap', name:'ãƒ¯ã‚¤ãƒ‰å¸½å­æ ä¸€å¼ï¼šMDP-SC', price:99000 },
    { id:'sai_tfa_90', name:'è¢‹ç‰©æ ï¼šTFAï¼šÏ†90', price:5000 },
    { id:'sai_tfa_120', name:'è¢‹ç‰©æ ï¼šTFAï¼šÏ†120', price:5000 },
    { id:'sai_tfa_150', name:'è¢‹ç‰©æ ï¼šTFAï¼šÏ†150', price:5000 },
    { id:'sai_tfa_180', name:'è¢‹ç‰©æ ï¼šTFAï¼šÏ†180', price:5000 },
    { id:'sai_pocket_clamp', name:'ãƒã‚±ãƒƒãƒˆç”¨ã‚¯ãƒ©ãƒ³ãƒ—æ ï¼š65Ã—100', price:22000 },
    { id:'sai_sock_frame', name:'é´ä¸‹æ ï¼šè¢‹ç‰©æ ç”¨', price:18000 },
    { id:'sai_sock_gauge', name:'é´ä¸‹æ ç”¨ã‚²ãƒ¼ã‚¸ï¼šå˜å“', price:5130 },
    { id:'sai_m_frame_kit', name:'Mãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ã‚­ãƒƒãƒ‰ï¼šå½©', price:71000 },
    { id:'sai_m_clip_50', name:'Mã‚¯ãƒªãƒƒãƒ—ï¼š50', price:4000 },
    { id:'sai_m_clip_100', name:'Mã‚¯ãƒªãƒƒãƒ—ï¼š100', price:6000 },
    { id:'sai_gauge_set_tgh3', name:'ã‚²ãƒ¼ã‚¸ã‚»ãƒƒãƒˆï¼šTGH3', price:30000 },
    { id:'sai_shoe_frame_set', name:'é´æ ã‚»ãƒƒãƒˆ', price:57000 },
    { id:'sai_hoopmaster_55', name:'ãƒ•ãƒ¼ãƒ—ãƒã‚¹ã‚¿ãƒ¼ä¸¸æ ï¼š5.5', price:57000 },
    { id:'sai_bobbin_winder_small', name:'ä¸‹ç³¸å·»è£…ç½®ï¼šå°å‹', price:28000 },
    { id:'sai_bag_frame_100', name:'è¢‹ç‰©æ 100Ã—100ï¼ˆæ¨™æº–è£…å‚™ã‚¿ã‚¤ãƒ—ï¼‰', price:7000 },
    { id:'sai_bag_frame_200_300', name:'è¢‹ç‰©æ 200Ã—300ï¼ˆæ¨™æº–è£…å‚™ã‚¿ã‚¤ãƒ—ï¼‰', price:7000 },
    { id:'sai_lan_license', name:'LANåˆºç¹æ©Ÿæ¥ç¶šãƒ©ã‚¤ã‚»ãƒ³ã‚¹ è¿½åŠ 2å°ç›®ä»¥é™', price:18000 },
    { id:'sai_writerplus_font_a', name:'Writerplusã‚¿ã‚¸ãƒæ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆ ã‚»ãƒƒãƒˆA', price:68000 },
    { id:'sai_writerplus_font_b', name:'Writerplusã‚¿ã‚¸ãƒæ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆ ã‚»ãƒƒãƒˆB', price:68000 },
    { id:'sai_writerplus_font_c', name:'Writerplusã‚¿ã‚¸ãƒæ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆ ã‚»ãƒƒãƒˆC', price:123000 },
  ];


  // å°‘æ•°é ­æ©Ÿãƒã‚¹ã‚¿ï¼ˆãƒ¢ãƒ‡ãƒ«ï¼‹é‡æ•°ï¼‹é ­æ•°ï¼‹ç¯„å›²ï¼‰
  const FEW_MODELS = [
    { 
      id:'TMEZ-K', 
      label:'TMEZ-KC', 
      needles:[9,12,15], 
      heads:[2,4,6,8], 
      fields:['450x360','450x500'], 
      displayName:'ã‚¿ã‚¸ãƒåˆºç¹æ©Ÿ TMEZ-KC ï¼ˆi-TM/DCP æ­è¼‰ãƒ¢ãƒ‡ãƒ«ï¼‰',
      // 2é ­æ©Ÿã¯450x500ã®ã¿
      fieldsByHeads: { 2: ['450x500'], 4: ['450x360','450x500'], 6: ['450x360','450x500'], 8: ['450x360','450x500'] }
    },
    { 
      id:'TMAR-K', 
      label:'TMAR-KC', 
      needles:[9,12,15], 
      heads:[2,4,6,8], 
      fields:['450x360','450x500'], 
      displayName:'ã‚¿ã‚¸ãƒåˆºç¹æ©Ÿ TMAR-KC TYPE2 (DCPæ­è¼‰ãƒ¢ãƒ‡ãƒ«)',
      // 2é ­æ©Ÿã¯450x500ã®ã¿
      fieldsByHeads: { 2: ['450x500'], 4: ['450x360','450x500'], 6: ['450x360','450x500'], 8: ['450x360','450x500'] }
    },
    { 
      id:'TFMX-2C', 
      label:'TFMX-2C', 
      needles:[6,9,12,15], 
      heads:[2,4,6,8], 
      fields:['450x360','450x500'], 
      displayName:'ã‚¿ã‚¸ãƒåˆºç¹æ©Ÿ TFMX-â…¡C TYPE2'
    },
  ];

  // ====== ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä¾¡æ ¼ãƒã‚¹ã‚¿ ======
  
  // åŸåæ ï¼ˆBFFï¼‰ä¾¡æ ¼
  const BFF_PRICES = {
    // TFMX-2Cï¼šå›ºå®šï¼ˆBFF2+BFF6ã®ã¿ï¼‰
    'TFMX-2C': {
      '2H-360': { 'BFF2+BFF6': 32000 },
      '2H-500': { 'BFF2+BFF6': 32000 },
      '4H-360': { 'BFF2+BFF6': 38000 },
      '4H-500': { 'BFF2+BFF6': 52000 },
      '6H-360': { 'BFF2+BFF6': 55000 },
      '6H-500': { 'BFF2+BFF6': 62000 },
      '8H-360': { 'BFF2+BFF6': 62000 },
      '8H-500': { 'BFF2+BFF6': 76000 }
    },
    // TMAR-KC / TMEZ-KCï¼š3ç¨®é¡ã‹ã‚‰é¸æŠ
    'TMAR-KC': {
      '2H-500': { 'BFF3+BFF8': 36000, 'BFF2+BFF4': 41000, 'BFF2+BFF6': 42000 },
      '4H-360': { 'BFF3+BFF8': 42000, 'BFF2+BFF4': 48000, 'BFF2+BFF6': 49000 },
      '4H-500': { 'BFF3+BFF8': 56000, 'BFF2+BFF4': 61000, 'BFF2+BFF6': 65000 },
      '6H-360': { 'BFF3+BFF8': 58000, 'BFF2+BFF4': 63000, 'BFF2+BFF6': 68000 },
      '6H-500': { 'BFF3+BFF8': 62000, 'BFF2+BFF4': 69000, 'BFF2+BFF6': 73000 },
      '8H-360': { 'BFF3+BFF8': 63000, 'BFF2+BFF4': 71000, 'BFF2+BFF6': 75000 },
      '8H-500': { 'BFF3+BFF8': 81000, 'BFF2+BFF4': 91000, 'BFF2+BFF6': 95000 }
    },
    'TMEZ-K': {
      '2H-500': { 'BFF3+BFF8': 36000, 'BFF2+BFF4': 41000, 'BFF2+BFF6': 42000 },
      '4H-360': { 'BFF3+BFF8': 42000, 'BFF2+BFF4': 48000, 'BFF2+BFF6': 49000 },
      '4H-500': { 'BFF3+BFF8': 56000, 'BFF2+BFF4': 61000, 'BFF2+BFF6': 65000 },
      '6H-360': { 'BFF3+BFF8': 58000, 'BFF2+BFF4': 63000, 'BFF2+BFF6': 68000 },
      '6H-500': { 'BFF3+BFF8': 62000, 'BFF2+BFF4': 69000, 'BFF2+BFF6': 73000 },
      '8H-360': { 'BFF3+BFF8': 63000, 'BFF2+BFF4': 71000, 'BFF2+BFF6': 75000 },
      '8H-500': { 'BFF3+BFF8': 81000, 'BFF2+BFF4': 91000, 'BFF2+BFF6': 95000 }
    },
    // å˜é ­æ©Ÿï¼š2ç¨®é¡ã‹ã‚‰é¸æŠï¼ˆåŸåæ ç”¨å“ä»˜ãï¼‰
    'SINGLE': {
      'BFF3+BFF8': 46000,
      'BFF2+BFF4': 49000
    }
  };

  // LEDç…§æ˜ä¾¡æ ¼
  const LED_PRICES = {
    'TFMX-2C': {
      '2H-360': 23000, '2H-500': 25000,
      '4H-360': 32000, '4H-500': 32000,
      '6H-360': 48000, '6H-500': 48000,
      '8H-360': 49000, '8H-500': 51000
    },
    'TMAR-KC': {
      '2H-500': 25000,
      '4H-360': 33000, '4H-500': 33000,
      '6H-360': 52000, '6H-500': 52000,
      '8H-360': 52000, '8H-500': 52000
    },
    'TMEZ-K': {
      '2H-500': 25000,
      '4H-360': 33000, '4H-500': 33000,
      '6H-360': 52000, '6H-500': 52000,
      '8H-360': 52000, '8H-500': 52000
    },
    'SINGLE': 8800  // å˜é ­æ©Ÿå…±é€š
  };

  // å¸½å­æ ä¾¡æ ¼
  const CAP_FRAME_PRICES = {
    'FEW': { 2: 111000, 4: 199000, 6: 288000, 8: 376000 },
    'SINGLE': 84000
  };

  // å›ºå®šä¾¡æ ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆè¡¨ç¤ºé †ï¼‰
  const FIXED_OPTIONS = [
    // å˜é ­æ©Ÿå°‚ç”¨ï¼ˆè¡¨ç¤ºé †ï¼‰
    { id: 'bagTable', name: 'è¢‹ç‰©æ ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«', price: 31000, models: ['single'], order: 3 },
    { id: 'leg', name: 'è„š', price: 58000, models: ['single'], order: 4 },
    { id: 'legTray', name: 'è„šãƒˆãƒ¬ã‚¤', price: 8000, models: ['single'], order: 5 },
    { id: 'positionMarker', name: 'ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚«ãƒ¼ 1H', price: 8000, models: ['single', 'few'], order: 7 },
    { id: 'bobbinWinder', name: 'ä¸‹ç³¸å·»è£…ç½®', price: 28000, models: ['single', 'few'], order: 8 },
    { id: 'laserMarker', name: 'ãƒ¬ãƒ¼ã‚¶ãƒ¼ã‚¯ãƒ­ã‚¹ãƒãƒ¼ã‚«ãƒ¼', price: 15000, models: ['single'], order: 9 },
    { id: 'sockFrameSet', name: 'å˜é ­æ©Ÿç”¨ ã‚¿ã‚¸ãƒé´ä¸‹æ ã‚»ãƒƒãƒˆ ã‚²ãƒ¼ã‚¸ä»˜ã', price: 23000, models: ['single'], order: 10 },
    { id: 'sockFrameSetMarusiki', name: 'å˜é ­æ©Ÿç”¨ ä¸¸æ­£å¼é´ä¸‹æ ã‚»ãƒƒãƒˆ ã‚²ãƒ¼ã‚¸ä»˜ã', price: 39000, models: ['single'], order: 11 },
    { id: 'mFrameKit', name: 'Mãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ã‚­ãƒƒãƒˆ 3', price: 143000, models: ['single'], order: 12 },
    { id: 'mClip50', name: 'Mã‚¯ãƒªãƒƒãƒ—ï¼š50', price: 4000, models: ['single'], order: 13 },
    { id: 'mClip100', name: 'Mã‚¯ãƒªãƒƒãƒ—ï¼š100', price: 6000, models: ['single'], order: 14 },
    { id: 'multiCode', name: 'ãƒãƒ«ãƒã‚³ãƒ¼ãƒ‰è£…ç½®2 1H', price: 87000, models: ['single'], order: 15 },
    { id: 'anshinSupport5y', name: 'å®‰å¿ƒå®šé¡ã‚µãƒãƒ¼ãƒˆï¼ˆ5å¹´é–“ï¼‰', price: 180000, models: ['single'], order: 16, group: 'support' },
  ];

  // æ©Ÿç¨®é™å®šãƒ»é¸æŠå¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³
  const MODEL_SPECIFIC_OPTIONS = {
    'TMEZ-S': [
      { id: 'esq_lr_no', name: 'ESQ-C L åˆã¯ R ç´ æç³¸åˆ‡ã‚Œã‚»ãƒ³ã‚µãƒ¼ç„¡', price: 186000 },
      { id: 'esq_lr_yes', name: 'ESQ-C L & R ç´ æç³¸åˆ‡ã‚Œã‚»ãƒ³ã‚µãƒ¼ç„¡', price: 303000 },
      { id: 'esq_lr_sensor_no', name: 'ESQ-C L åˆã¯ R ç´ æç³¸åˆ‡ã‚Œã‚»ãƒ³ã‚µãƒ¼æœ‰', price: 188000 },
      { id: 'esq_lr_sensor_yes', name: 'ESQ-C L & R ç´ æç³¸åˆ‡ã‚Œã‚»ãƒ³ã‚µãƒ¼æœ‰', price: 308000 }
    ],
    'TMBR2-S': [
      { id: 'sequin_2_9_lr', name: 'ã‚·ãƒ¼ã‚¯ã‚¤ãƒ³â…£ 2mmï½9mm L åˆã¯ R', price: 169000 },
      { id: 'sequin_2_9_lr_both', name: 'ã‚·ãƒ¼ã‚¯ã‚¤ãƒ³â…£ 2mmï½9mm L & R', price: 231000 },
      { id: 'sequin_2_22_lr', name: 'ã‚·ãƒ¼ã‚¯ã‚¤ãƒ³â…£ 2mmï½22mm L åˆã¯ R', price: 181000 },
      { id: 'sequin_2_22_lr_both', name: 'ã‚·ãƒ¼ã‚¯ã‚¤ãƒ³â…£ 2mmï½22mm L & R', price: 255000 }
    ],
    'TMBP2-S': [
      { id: 'sequin_2_9_lr', name: 'ã‚·ãƒ¼ã‚¯ã‚¤ãƒ³â…£ 2mmï½9mm L åˆã¯ R', price: 169000 },
      { id: 'sequin_2_9_lr_both', name: 'ã‚·ãƒ¼ã‚¯ã‚¤ãƒ³â…£ 2mmï½9mm L & R', price: 231000 },
      { id: 'sequin_2_22_lr', name: 'ã‚·ãƒ¼ã‚¯ã‚¤ãƒ³â…£ 2mmï½22mm L åˆã¯ R', price: 181000 },
      { id: 'sequin_2_22_lr_both', name: 'ã‚·ãƒ¼ã‚¯ã‚¤ãƒ³â…£ 2mmï½22mm L & R', price: 255000 }
    ]
  };

  // =========================================================


  // === è¿½åŠ ï¼šåˆºç¹æ ï¼ˆTFA/TFA2ï¼‰ãƒã‚¹ã‚¿ï¼ˆxlsx ã‹ã‚‰ç”Ÿæˆï¼‰ ===
  const TFA_FRAMES = [{"id": "TFA-70", "type": "TFA", "frameType": "360P", "price": 2600, "compat": {"TMEZ-KC_360": true, "TMEZ-KC_500": true, "TMAR-KC_360": true, "TMAR-KC_500": true, "TFMX-2C_360": true, "TFMX-2C_500": true, "TMBP2-XC_600": true, "SINGLE_500": true}}, {"id": "TFA-90", "type": "TFA", "frameType": "360P", "price": 2600, "compat": {"TMEZ-KC_360": true, "TMEZ-KC_500": true, "TMAR-KC_360": true, "TMAR-KC_500": true, "TFMX-2C_360": true, "TFMX-2C_500": true, "TMBP2-XC_600": true, "SINGLE_500": true}}, {"id": "TFA-120", "type": "TFA", "frameType": "360P", "price": 2600, "compat": {"TMEZ-KC_360": true, "TMEZ-KC_500": true, "TMAR-KC_360": true, "TMAR-KC_500": true, "TFMX-2C_360": true, "TFMX-2C_500": true, "TMBP2-XC_600": true, "SINGLE_500": true}}, {"id": "TFA-150", "type": "TFA", "frameType": "360P", "price": 2600, "compat": {"TMEZ-KC_360": true, "TMEZ-KC_500": true, "TMAR-KC_360": true, "TMAR-KC_500": true, "TFMX-2C_360": true, "TFMX-2C_500": true, "TMBP2-XC_600": true, "SINGLE_500": true}}, {"id": "TFA-180", "type": "TFA", "frameType": "360P", "price": 2600, "compat": {"TMEZ-KC_360": true, "TMEZ-KC_500": true, "TMAR-KC_360": true, "TMAR-KC_500": true, "TFMX-2C_360": true, "TFMX-2C_500": true, "TMBP2-XC_600": true, "SINGLE_500": true}}, {"id": "TFA-210", "type": "TFA", "frameType": "360P", "price": 2600, "compat": {"TMEZ-KC_360": true, "TMEZ-KC_500": true, "TMAR-KC_360": true, "TMAR-KC_500": true, "TFMX-2C_360": true, "TFMX-2C_500": true, "TMBP2-XC_600": true, "SINGLE_500": true}}, {"id": "TFA-210X120", "type": "TFA", "frameType": "360P", "price": 3500, "compat": {"TMEZ-KC_360": true, "TMEZ-KC_500": true, "TMAR-KC_360": true, "TMAR-KC_500": true, "TFMX-2C_360": true, "TFMX-2C_500": true, "TMBP2-XC_600": true, "SINGLE_500": true}}, {"id": "TFA255X255", "type": "TFA", "frameType": "360P", "price": 3600, "compat": {"TMEZ-KC_360": true, "TMEZ-KC_500": true, "TMAR-KC_360": true, "TMAR-KC_500": true, "TFMX-2C_360": true, "TFMX-2C_500": true, "TMBP2-XC_600": true, "SINGLE_500": true}}, {"id": "TFA260X335", "type": "TFA", "frameType": "360P", "price": 4500, "compat": {"TMEZ-KC_360": true, "TMEZ-KC_500": true, "TMAR-KC_360": true, "TMAR-KC_500": true, "TFMX-2C_360": true, "TFMX-2C_500": true, "TMBP2-XC_600": true, "SINGLE_500": true}}, {"id": "TFA2:340X310", "type": "TFA2", "frameType": "360P", "price": null, "compat": {"TMEZ-KC_360": true, "TMEZ-KC_500": true, "TMAR-KC_360": true, "TMAR-KC_500": true, "TFMX-2C_360": true, "TFMX-2C_500": true, "TMBP2-XC_600": true, "SINGLE_500": true}}, {"id": "TFA255X160", "type": "TFA", "frameType": "360P", "price": 4000, "compat": {"TMEZ-KC_360": true, "TMEZ-KC_500": true, "TMAR-KC_360": true, "TMAR-KC_500": true, "TFMX-2C_360": true, "TFMX-2C_500": true, "TMBP2-XC_600": true, "SINGLE_500": true}}, {"id": "TFA395X325", "type": "TFA", "frameType": "360P", "price": 5000, "compat": {"TMEZ-KC_360": true, "TMEZ-KC_500": true, "TMAR-KC_360": true, "TMAR-KC_500": true, "TFMX-2C_360": true, "TFMX-2C_500": true, "TMBP2-XC_600": true, "SINGLE_500": true}}, {"id": "TFA2:335X453", "type": "TFA2", "frameType": "360P", "price": 6400, "compat": {"TMEZ-KC_360": true, "TMEZ-KC_500": true, "TMAR-KC_360": true, "TMAR-KC_500": true, "TFMX-2C_360": true, "TFMX-2C_500": true, "TMBP2-XC_600": true, "SINGLE_500": true}}, {"id": "TFA2:413X239", "type": "TFA2", "frameType": "360P", "price": 6100, "compat": {"TMEZ-KC_360": true, "TMEZ-KC_500": true, "TMAR-KC_360": true, "TMAR-KC_500": true, "TFMX-2C_360": true, "TFMX-2C_500": true, "TMBP2-XC_600": true, "SINGLE_500": true}}, {"id": "TFA2:413X342", "type": "TFA2", "frameType": "360P", "price": 5900, "compat": {"TMEZ-KC_360": true, "TMEZ-KC_500": true, "TMAR-KC_360": true, "TMAR-KC_500": true, "TFMX-2C_360": true, "TFMX-2C_500": true, "TMBP2-XC_600": true, "SINGLE_500": true}}, {"id": "TFA465X320", "type": "TFA", "frameType": "360P", "price": null, "compat": {"TMEZ-KC_360": true, "TMEZ-KC_500": true, "TMAR-KC_360": true, "TMAR-KC_500": true, "TFMX-2C_360": true, "TFMX-2C_500": true, "TMBP2-XC_600": true, "SINGLE_500": true}}, {"id": "TFA2:510X310", "type": "TFA2", "frameType": "360P", "price": 6100, "compat": {"TMEZ-KC_360": true, "TMEZ-KC_500": true, "TMAR-KC_360": true, "TMAR-KC_500": true, "TFMX-2C_360": true, "TFMX-2C_500": true, "TMBP2-XC_600": true}}, {"id": "TFA2:335X453", "type": "TFA2", "frameType": "500ï¼°", "price": 6400, "compat": {"TMEZ-KC_500": true, "TMAR-KC_500": true, "TFMX-2C_500": true, "TMBP2-XC_600": true, "SINGLE_500": true}}, {"id": "TFA2:413X467", "type": "TFA2", "frameType": "500ï¼°", "price": 6300, "compat": {"TMEZ-KC_500": true, "TMAR-KC_500": true, "TFMX-2C_500": true, "TMBP2-XC_600": true, "SINGLE_500": true}}, {"id": "TFA2:510X450", "type": "TFA2", "frameType": "500ï¼°", "price": 6200, "compat": {"TMEZ-KC_500": true, "TMAR-KC_500": true, "TFMX-2C_500": true, "TMBP2-XC_600": true}}, {"id": "TFA2:410X555", "type": "TFA2", "frameType": "", "price": null, "compat": {"TFMX-2C_500": true, "TMBP2-XC_600": true, "SINGLE_500": true}}, {"id": "TFA2:610X625", "type": "TFA2", "frameType": "", "price": 8800, "compat": {"TMBP2-XC_600": true}}];

  function getTFACompatKey(){
    const catEl = document.getElementById('machineCategory');
    const modelEl = document.getElementById('machineModel');
    const fieldEl = document.getElementById('machineField');

    const cat = catEl ? catEl.value : 'single';
    const modelId = modelEl ? modelEl.value : '';
    const field = fieldEl ? fieldEl.value : '';

    // ç¸¦å¯¸ï¼ˆYï¼‰ã‚’æŠ½å‡ºï¼š"450x500" -> 500
    let y = 500;
    if(cat === 'few'){
      const m = String(field).match(/x(\d+)/);
      if(m) y = parseInt(m[1],10);
    }

    // ãƒ¢ãƒ‡ãƒ«ã‚­ãƒ¼ã‚’å¯¾å¿œè¡¨ã«å¯„ã›ã‚‹
    let mk = 'SINGLE';
    if(cat === 'few'){
      if(modelId === 'TMEZ-K') mk = 'TMEZ-KC';
      else if(modelId === 'TMAR-K') mk = 'TMAR-KC';
      else if(modelId === 'TFMX-2C') mk = 'TFMX-2C';
      else if(modelId === 'TMBP2-XC') mk = 'TMBP2-XC';
      else mk = modelId;
    }

    // TMBP2-XC ã¯ 600å›ºå®šï¼ˆè¡¨ã‚‚ 600åˆ—ã®ã¿ï¼‰
    if(mk === 'TMBP2-XC') y = 600;

    return mk + '_' + String(y);
  }

  function renderTFAList(){
    const list = document.getElementById('tfaList');
    const sumEl = document.getElementById('tfaSummary');
    if(!list) return;

    const key = getTFACompatKey();
    const candidates = TFA_FRAMES.filter(f => f.compat && f.compat[key]);

    // æ—¢å­˜é¸æŠã®ä¿æŒï¼ˆåŒã˜IDã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ãƒ»æ•°é‡ãƒ»å˜ä¾¡ï¼‰
    const prevChecked = {};
    const prevQty = {};
    const prevPrice = {};
    document.querySelectorAll('#tfaList input[type=checkbox][data-tfa-id]').forEach(cb=>{
      const id = cb.getAttribute('data-tfa-id');
      if(id) prevChecked[id] = cb.checked;
    });
    document.querySelectorAll('#tfaList input[type=number][data-tfa-qty]').forEach(inp=>{
      const id = inp.getAttribute('data-tfa-qty');
      if(id) prevQty[id] = inp.value;
    });
    document.querySelectorAll('#tfaList input[type=number][data-tfa-price]').forEach(inp=>{
      const id = inp.getAttribute('data-tfa-price');
      if(id) prevPrice[id] = inp.value;
    });

    list.innerHTML = '';

    if(!candidates.length){
      list.innerHTML = '<div class="muted">ï¼ˆã“ã®æ©Ÿç¨®/ç¯„å›²ã§é¸ã¹ã‚‹TFAæ ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰</div>';
      if(sumEl) sumEl.textContent = '';
      return;
    }

    candidates.forEach(f=>{
      const row = document.createElement('div');
      const isOn = !!prevChecked[f.id];
      row.className = 'opt-row ' + (isOn ? 'on' : 'off');
      row.id = 'tfa_row_' + f.id.replace(/[^a-zA-Z0-9_-]/g,'_');

      // ã‚¹ã‚¤ãƒƒãƒï¼ˆä»–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨åŒã˜UIï¼‰
      const sw = document.createElement('label');
      sw.className = 'switch';

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.setAttribute('data-tfa-id', f.id);
      cb.checked = isOn;
      cb.addEventListener('change', ()=>{
        row.classList.toggle('on', cb.checked);
        row.classList.toggle('off', !cb.checked);
        applyAndRender();
      });

      const slider = document.createElement('span');
      slider.className = 'slider';

      sw.appendChild(cb);
      sw.appendChild(slider);

      const label = document.createElement('div');
      label.className = 'opt-label';
      const priceText = (f.price == null) ? 'ä¾¡æ ¼æœªè¨­å®š' : ('Â¥' + Number(f.price).toLocaleString());
      const typeText = (f.type || 'TFA') + (f.frameType ? (' / ' + f.frameType) : '');
      label.innerHTML =
        '<div style="font-weight:700">' + f.id + '</div>' +
        '<div class="muted" style="font-size:12px">' + typeText + ' / ' + priceText + '</div>';

      // å˜ä¾¡ï¼ˆä¾¡æ ¼æœªè¨­å®šã®æ ã¯æ‰‹å…¥åŠ›å¯ï¼‰
      const price = document.createElement('input');
      price.type = 'number';
      price.min = '0';
      price.step = '100';
      price.placeholder = 'å˜ä¾¡';
      price.style.width = '120px';
      price.style.textAlign = 'right';
      price.setAttribute('data-tfa-price', f.id);
      if(f.price != null) price.value = String(f.price);
      else if(prevPrice[f.id] != null) price.value = String(prevPrice[f.id]);
      price.addEventListener('input', ()=>applyAndRender());

      // æ•°é‡
      const qty = document.createElement('input');
      qty.type = 'number';
      qty.min = '1';
      qty.step = '1';
      qty.className = 'opt-qty';
      qty.value = prevQty[f.id] != null ? String(prevQty[f.id]) : '1';
      qty.setAttribute('data-tfa-qty', f.id);
      qty.addEventListener('input', ()=>applyAndRender());

      row.appendChild(sw);
      row.appendChild(label);
      row.appendChild(price);
      row.appendChild(qty);
      list.appendChild(row);
    });

    // ã‚µãƒãƒªãƒ¼æ›´æ–°
    updateTFASummary();
  }

  function getSelectedTFAItems(){
    const items = [];
    const list = document.getElementById('tfaList');
    if(!list) return items;

    list.querySelectorAll('input[type=checkbox][data-tfa-id]').forEach(cb=>{
      if(!cb.checked) return;
      const id = cb.getAttribute('data-tfa-id');
      const qtyEl = list.querySelector('input[type=number][data-tfa-qty="' + id + '"]');
      const priceEl = list.querySelector('input[type=number][data-tfa-price="' + id + '"]');
      const qty = Math.max(1, parseInt(qtyEl ? (qtyEl.value || '1') : '1', 10));
      const unit = Math.max(0, parseInt(priceEl ? (priceEl.value || '0') : '0', 10));
      items.push({ name: 'åˆºç¹æ ï¼š' + id, qty: qty, unitPrice: unit });
    });
    return items;
  }

  function getSelectedDGLessonItem(){
    const cb = document.getElementById('dgopt_DG_LESSON');
    if(!cb || !cb.checked) return null;
    const priceEl = document.getElementById('dgopt_DG_LESSON_price');
    const qtyEl = document.getElementById('dgopt_DG_LESSON_qty');
    const unitPrice = Math.max(0, parseInt(priceEl?.value || '0', 10)) || 0;
    const qty = Math.max(1, parseInt(qtyEl?.value || '1', 10)) || 1;
    return { name:'DGè¬›ç¿’è²»ç”¨', qty, unitPrice };
  }


  function updateTFASummary(){
    const sumEl = document.getElementById('tfaSummary');
    if(!sumEl) return;
    const items = getSelectedTFAItems();
    if(!items.length){
      sumEl.textContent = '';
      return;
    }
    const total = items.reduce((s,it)=>s + (Number(it.unitPrice)||0) * (Number(it.qty)||0), 0);
    sumEl.textContent = items.length + 'é …ç›® / åˆè¨ˆ ' + total.toLocaleString();
  }

  function resetTFASection(){
    const panel = document.getElementById('tfaPanel');
    const list = document.getElementById('tfaList');
    const sumEl = document.getElementById('tfaSummary');

    if(list){
      list.querySelectorAll('input[type=checkbox][data-tfa-id]').forEach(cb=>{ cb.checked = false; });
      list.querySelectorAll('input[type=number][data-tfa-qty]').forEach(inp=>{ inp.value = '1'; });
      // å˜ä¾¡ã¯ã€ŒåˆæœŸå€¤ï¼ˆãƒã‚¹ã‚¿ã«ã‚ã‚‹ã‚‚ã®ï¼‰ã€ã¸æˆ»ã™ãŸã‚å†æç”»
    }
    if(sumEl) sumEl.textContent = '';
    // å†æç”»ã—ã¦åˆæœŸå˜ä¾¡ã«æˆ»ã™
    renderTFAList();
    if(panel) panel.open = false;
    applyAndRender();
  }

  // åˆºç¹ã‚½ãƒ•ãƒˆï¼ˆDGï¼‰ä¾¡æ ¼ãƒ»é¸æŠãƒ«ãƒ¼ãƒ«ï¼ˆAæ¡ˆï¼šDG-Sã¯åˆ¥æ ï¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³/ãƒ•ã‚©ãƒ³ãƒˆä¸å¯ï¼‰
  // =========================================================
  const DG_SOFTWARE = [
    { id:'WRITER_PLUS', name:'Writer Plusï¼ˆå½© ä»˜å±ï¼‰', price:0, optionsEnabled:false, fontsEnabled:false, lanRule:'WP' },
    { id:'EXPRESS', name:'EXPRESS', price:165000, optionsEnabled:false, fontsEnabled:false, lanRule:'DG' },
    { id:'COMPOSER', name:'COMPOSER', price:308000, optionsEnabled:true,  fontsEnabled:true,  lanRule:'DG' },
    { id:'CREATOR', name:'CREATOR', price:451000, optionsEnabled:true,  fontsEnabled:true,  lanRule:'DG' },
    { id:'ILLUSTRATOR_EXTREME', name:'ILLUSTRATOR EXTREME', price:615000, optionsEnabled:true,  fontsEnabled:true,  lanRule:'DG' },
    { id:'ARTIST_PLUS', name:'ARTIST PLUS', price:801000, optionsEnabled:true,  fontsEnabled:true,  lanRule:'DG' },
    { id:'MAESTRO', name:'MAESTRO', price:1081000, optionsEnabled:true,  fontsEnabled:true,  lanRule:'DG' },
    { id:'DG_S', name:'DG-S', price:215000, optionsEnabled:false, fontsEnabled:false, lanRule:'DG' }
  ];

  // minGrade ã¯ã€Œã“ã®ã‚°ãƒ¬ãƒ¼ãƒ‰ä»¥ä¸Šã€ã§é¸æŠå¯ï¼ˆDG-Sã¯åˆ¤å®šå¯¾è±¡å¤–ãªã®ã§å…¥ã‚Œãªã„ï¼‰
  const DG_OPTIONS = [
    { id:'ELEMENT', name:'ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆ', price:57000, minGrade:'CREATOR' },
    { id:'EVERYTHING_SEQUIN_PACK', name:'ã‚¨ãƒ–ãƒªã‚·ãƒ³ã‚°ã‚·ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‘ãƒƒã‚¯', price:299000, minGrade:'CREATOR' },
    { id:'BEADS_PACK', name:'ãƒ“ãƒ¼ã‚ºãƒ‘ãƒƒã‚¯', price:437000, minGrade:'CREATOR' },
    { id:'PHOTO_CREATOR', name:'ãƒ•ã‚©ãƒˆã‚¯ãƒªã‚¨ãƒ¼ã‚¿ãƒ¼', price:121000, minGrade:'ILLUSTRATOR_EXTREME' },
    { id:'CHENILLE', name:'ã‚·ã‚§ãƒ‹ãƒ¼ãƒ«', price:156000, minGrade:'CREATOR' },
    { id:'DIRECT_MACHINE_HOLDER', name:'ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒã‚·ãƒ³ãƒ›ãƒ«ãƒ€ãƒ¼', price:42000, minGrade:'COMPOSER' },
    { id:'CHENILLE_TUCKING', name:'ã‚·ã‚§ãƒ‹ãƒ¼ãƒ«ã‚¿ãƒƒã‚­ãƒ³ã‚°', price:63000, minGrade:'COMPOSER' },
    { id:'HEAD_GROUP', name:'ãƒ˜ãƒƒãƒ‰ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆåˆºç¹æ©Ÿãƒ˜ãƒƒãƒ‰é¸æŠï¼‰', price:137000, minGrade:'ILLUSTRATOR_EXTREME' }
  ];

  const DG_FONTS = [
    { id:'FONT_1', name:'ãƒ•ã‚©ãƒ³ãƒˆ1ï¼ˆæ—¥æœ¬èªä»¥å¤–ï¼‰', price:38000, minGrade:'COMPOSER' },
    { id:'SEQUIN_FONT_PACK', name:'ã‚·ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ•ã‚©ãƒ³ãƒˆãƒ‘ãƒƒã‚¯', price:72000, minGrade:'COMPOSER' },
    { id:'MONOGRAM_FONT_PACK', name:'ãƒ¢ãƒã‚°ãƒ©ãƒ ãƒ•ã‚©ãƒ³ãƒˆãƒ‘ãƒƒã‚¯', price:72000, minGrade:'COMPOSER' },
    { id:'PLATINUM_FONT_PACK', name:'ãƒ—ãƒ©ãƒãƒŠãƒ ãƒ•ã‚©ãƒ³ãƒˆãƒ‘ãƒƒã‚¯', price:180000, minGrade:'COMPOSER' },
    { id:'FONT_MEDLEY', name:'ãƒ•ã‚©ãƒ³ãƒˆãƒ¡ãƒ‰ãƒ¬ãƒ¼', price:72000, minGrade:'COMPOSER' },
    { id:'SYMPHONY_1_FONT_PACK', name:'ã‚·ãƒ³ãƒ•ã‚©ãƒ‹ãƒ¼1 ãƒ•ã‚©ãƒ³ãƒˆãƒ‘ãƒƒã‚¯', price:46000, minGrade:'COMPOSER' },
    { id:'NONAKA_FONT', name:'é‡ä¸­ãƒ•ã‚©ãƒ³ãƒˆ', price:72000, minGrade:'COMPOSER' },
    { id:'TAJIMA_JP_FONT_DGA', name:'ã‚¿ã‚¸ãƒæ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆï¼šDG:A', price:68000, minGrade:'COMPOSER' },
    { id:'TAJIMA_JP_FONT_DGB', name:'ã‚¿ã‚¸ãƒæ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆï¼šDG:B', price:68000, minGrade:'COMPOSER' },
    { id:'TAJIMA_JP_FONT_DGC', name:'ã‚¿ã‚¸ãƒæ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆï¼šDG:Cï¼ˆA+Bã‚»ãƒƒãƒˆï¼‰', price:123000, minGrade:'COMPOSER' },
    { id:'TAJIMA_JP_FONT_PACK', name:'ã‚¿ã‚¸ãƒæ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆãƒ‘ãƒƒã‚¯ï¼ˆç¾æ¨™æº–ãƒ•ã‚©ãƒ³ãƒˆï¼‰', price:50000, minGrade:'COMPOSER' }
  ];

  const DG_LAN_LICENSES = {
    DG: { id:'LAN_DG', name:'LANåˆºç¹æ©Ÿãƒ©ã‚¤ã‚»ãƒ³ã‚¹ï¼ˆDGï¼‰', price:37000, note:'2ã€œ10å°ç›®ã¾ã§ã®æ¥ç¶šï¼ˆè¿½åŠ ï¼‰' },
    WP: { id:'LAN_WRITER_PLUS', name:'LANåˆºç¹æ©Ÿãƒ©ã‚¤ã‚»ãƒ³ã‚¹ï¼ˆãƒ©ã‚¤ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¹ï¼‰', price:18000, note:'2å°ç›®ã€œ5å°ç›®ã®æ¥ç¶šï¼ˆè¿½åŠ ï¼‰' }
  };

  // ====== ä¾¡æ ¼ãƒã‚¹ã‚¿ï¼ˆå®Œå…¨ç‰ˆï¼‰ ======
  // ã‚­ãƒ¼ã¯ã€Œè¦‹ç©ç•ªå·ã«å…¥ã‚Œã‚‹ãƒ¢ãƒ‡ãƒ«åã€ï¼šä¾‹ï¼‰TMEZ-K1502C / TMBR2-S1501C
  const PRICE_MASTER = {
    // å½©ï¼ˆSAIï¼‰
    'MDP-S0801C': 1100000,

    // å˜é ­æ©Ÿ TMAR-Kç³»ï¼ˆ450x360 / 450x500ï¼‰
    'TMAR-K0902C': 3872000,
    'TMAR-K0904C': 4620000,
    'TMAR-K0904C-500': 5231000,
    'TMAR-K0906C': 5846000,
    'TMAR-K0906C-500': 6319000,
    'TMAR-K0908C': 6901000,
    'TMAR-K0908C-500': 7690000,
    
    'TMAR-K1202C': 3935000,
    'TMAR-K1204C': 4738000,
    'TMAR-K1204C-500': 5348000,
    'TMAR-K1206C': 6017000,
    'TMAR-K1206C-500': 6444000,
    'TMAR-K1208C': 7128000,
    'TMAR-K1208C-500': 7924000,
    
    'TMAR-K1502C': 4002000,
    'TMAR-K1504C': 4864000,
    'TMAR-K1504C-500': 5478000,
    'TMAR-K1506C': 6201000,
    'TMAR-K1506C-500': 6641000,
    'TMAR-K1508C': 7374000,
    'TMAR-K1508C-500': 8186000,

    // å˜é ­æ©Ÿ TMEZ-Sç³»ï¼ˆ360x500å›ºå®šï¼‰
    'TMEZ-S0901C': 2537000,
    'TMEZ-S1201C': 2570000,
    'TMEZ-S1501C': 2600000,

    // å˜é ­æ©Ÿ TMBR2-Sç³»ï¼ˆ360x500å›ºå®šï¼‰
    'TMBR2-S0601C': 2151000,
    'TMBR2-S1201C': 2209000,
    'TMBR2-S1501C': 2242000,
    'TMBR2-S1801C': 2349000,

    // å˜é ­æ©Ÿ TMBP2-Sç³»ï¼ˆ360x500å›ºå®šï¼‰
    'TMBP2-S0601C': 1965000,
    'TMBP2-S1201C': 2026000,
    'TMBP2-S1501C': 2056000,

    // å°‘æ•°é ­æ©Ÿ TFMX-2Cç³»
    'TFMX-2C0602': 3178000,
    'TFMX-2C0602-500': 3391000,
    'TFMX-2C0604': 3949000,
    'TFMX-2C0604-500': 4364000,
    'TFMX-2C0606': 4748000,
    'TFMX-2C0606-500': 5333000,
    'TFMX-2C0608': 5611000,
    'TFMX-2C0608-500': 6402000,

    'TFMX-2C0902': 3228000,
    'TFMX-2C0902-500': 3441000,
    'TFMX-2C0904': 4049000,
    'TFMX-2C0904-500': 4464000,
    'TFMX-2C0906': 4896000,
    'TFMX-2C0906-500': 5483000,
    'TFMX-2C0908': 5811000,
    'TFMX-2C0908-500': 6604000,

    'TFMX-2C1202': 3267000,
    'TFMX-2C1202-500': 3481000,
    'TFMX-2C1204': 4127000,
    'TFMX-2C1204-500': 4543000,
    'TFMX-2C1206': 5015000,
    'TFMX-2C1206-500': 5601000,
    'TFMX-2C1208': 5967000,
    'TFMX-2C1208-500': 6761000,

    'TFMX-2C1502': 3294000,
    'TFMX-2C1502-500': 3509000,
    'TFMX-2C1504': 4183000,
    'TFMX-2C1504-500': 4599000,
    'TFMX-2C1506': 5099000,
    'TFMX-2C1506-500': 5685000,
    'TFMX-2C1508': 6080000,
    'TFMX-2C1508-500': 6873000,

    // å°‘æ•°é ­æ©Ÿ TMEZ-Kç³»
    'TMEZ-KC0902C': 4743000,
    'TMEZ-KC0902C-500': 4743000,
    'TMEZ-KC0904C': 5790000,
    'TMEZ-KC0904C-500': 6409000,
    'TMEZ-KC0906C': 7519000,
    'TMEZ-KC0906C-500': 7930000,
    'TMEZ-KC0908C': 8872000,
    'TMEZ-KC0908C-500': 9666000,

    'TMEZ-KC1202C': 4796000,
    'TMEZ-KC1202C-500': 4796000,
    'TMEZ-KC1204C': 5904000,
    'TMEZ-KC1204C-500': 6520000,
    'TMEZ-KC1206C': 7690000,
    'TMEZ-KC1206C-500': 8101000,
    'TMEZ-KC1208C': 9098000,
    'TMEZ-KC1208C-500': 9890000,

    'TMEZ-KC1502C': 4852000,
    'TMEZ-KC1502C-500': 4852000,
    'TMEZ-KC1504C': 6014000,
    'TMEZ-KC1504C-500': 6632000,
    'TMEZ-KC1506C': 7857000,
    'TMEZ-KC1506C-500': 8267000,
    'TMEZ-KC1508C': 9322000,
    'TMEZ-KC1508C-500': 10114000,

    // å°‘æ•°é ­æ©Ÿ TMAR-KCç³»
    'TMAR-KC0902C': 3872000,
    'TMAR-KC0902C-500': 3872000,
    'TMAR-KC0904C': 4620000,
    'TMAR-KC0904C-500': 5231000,
    'TMAR-KC0906C': 5846000,
    'TMAR-KC0906C-500': 6319000,
    'TMAR-KC0908C': 6901000,
    'TMAR-KC0908C-500': 7690000,

    'TMAR-KC1202C': 3935000,
    'TMAR-KC1202C-500': 3935000,
    'TMAR-KC1204C': 4738000,
    'TMAR-KC1204C-500': 5348000,
    'TMAR-KC1206C': 6017000,
    'TMAR-KC1206C-500': 6444000,
    'TMAR-KC1208C': 7128000,
    'TMAR-KC1208C-500': 7924000,

    'TMAR-KC1502C': 4002000,
    'TMAR-KC1502C-500': 4002000,
    'TMAR-KC1504C': 4864000,
    'TMAR-KC1504C-500': 5478000,
    'TMAR-KC1506C': 6201000,
    'TMAR-KC1506C-500': 6641000,
    'TMAR-KC1508C': 7374000,
    'TMAR-KC1508C-500': 8186000,
  };

  let basePriceManuallyEdited = false;

  function initMachineUI(){
    const cat = document.getElementById('machineCategory');
    const model = document.getElementById('machineModel');
    const needles = document.getElementById('machineNeedles');
    const heads = document.getElementById('machineHeads');
    const field = document.getElementById('machineField');
    const unit = document.getElementById('baseUnitPrice');

    cat.addEventListener('change', ()=>{
      basePriceManuallyEdited = false;
      updateMachineSelectors();
      onMachineChanged();
    });
    model.addEventListener('change', ()=>{
      basePriceManuallyEdited = false;
      updateNeedlesHeadsFields();
      onMachineChanged();
    });
    needles.addEventListener('change', ()=>{
      basePriceManuallyEdited = false;
      onMachineChanged();
    });
    heads.addEventListener('change', ()=>{
      basePriceManuallyEdited = false;
      updateFieldOptions(); // é ­æ•°å¤‰æ›´æ™‚ã«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é¸æŠè‚¢ã‚’æ›´æ–°
      onMachineChanged();
    });
    field.addEventListener('change', ()=>{
      basePriceManuallyEdited = false;
      onMachineChanged();
    });

    unit.addEventListener('input', ()=>{
      basePriceManuallyEdited = true;
      applyAndRender();
    });

    updateMachineSelectors();
    onMachineChanged();
  }

  function updateMachineSelectors(){
    const cat = document.getElementById('machineCategory').value;
    const model = document.getElementById('machineModel');
    model.innerHTML = '';

    // åŒºåˆ†åˆ¥ï¼šæ©Ÿç¨®ãƒªã‚¹ãƒˆ
    let list;
    if(cat === 'few') list = FEW_MODELS;
    else if(cat === 'sai') list = SAI_MODELS;
    else list = SINGLE_SERIES;

    list.forEach((m,i)=>{
      const opt = document.createElement('option');
      opt.value = m.id;
      opt.textContent = m.label;
      if(i===0) opt.selected = true;
      model.appendChild(opt);
    });

    updateNeedlesHeadsFields();

    // ç”»é¢ï¼šTFAã‚«ãƒ¼ãƒ‰ã¯å½©ã§ã¯éè¡¨ç¤ºï¼ˆå½©ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«é›†ç´„ï¼‰
    // åˆºç¹ã‚½ãƒ•ãƒˆï¼ˆDGï¼‰ã‚«ãƒ¼ãƒ‰ã¯å½©ã§ã‚‚è¡¨ç¤ºï¼ˆå®Ÿéš›ã®è¦‹ç©ã‚‚ã‚Šã§å½©ã¨DGã®çµ„ã¿åˆã‚ã›ãŒã‚ã‚‹ãŸã‚ï¼‰
    const cardTFA = document.getElementById('cardTFA');
    const cardDG  = document.getElementById('cardDG');
    if(cardTFA) cardTFA.style.display = (cat === 'sai') ? 'none' : '';
    // DGã‚«ãƒ¼ãƒ‰ã¯å¸¸ã«è¡¨ç¤º
    if(cardDG)  cardDG.style.display  = '';

    // é‹é€è²»ï¼šå°‘æ•°é ­æ©Ÿã¯ã€Œãã®ä»–ï¼ˆæ‰‹å…¥åŠ›ï¼‰ã€ã‚’åŸºæœ¬ã«ã™ã‚‹
    const region = document.getElementById('region');
    const other = document.getElementById('regionOtherPrice');
    const shippingTitle = document.getElementById('shippingTitle');

    // åœ°åŸŸãƒ©ãƒ™ãƒ«ã¯åŒºåˆ†ã§å¤‰ãˆã‚‹ï¼ˆPDFã®é‹é€æ®ä»˜è¡¨ã«åŸºã¥ãï¼‰
    // å½©ç”¨ã¨å˜é ­æ©Ÿç”¨ã§é¸æŠè‚¢ãŒç•°ãªã‚‹ãŸã‚ã€optionè¦ç´ è‡ªä½“ã‚’å†æ§‹ç¯‰
    
    if(cat === 'few'){
      // å°‘æ•°é ­æ©Ÿï¼šå˜é ­æ©Ÿã¨åŒã˜é¸æŠè‚¢ã‚’è¡¨ç¤ºï¼ˆå®Ÿé‹ç”¨ã¯æ‰‹å…¥åŠ›ï¼‰
      region.innerHTML = `
        <option value="kinki">å˜é ­æ©Ÿï¼šè¿‘ç•¿ï¼ˆ100,000å††ï¼‰</option>
        <option value="chugoku">å˜é ­æ©Ÿï¼šä¸­å›½ï¼ˆ130,000å††ï¼‰</option>
        <option value="shikoku">å˜é ­æ©Ÿï¼šå››å›½ï¼ˆ140,000å††ï¼‰</option>
        <option value="kyushu">å˜é ­æ©Ÿï¼šä¹å·ï¼ˆ170,000å††ï¼‰</option>
        <option value="other" selected>ãã®ä»–ï¼ˆè¦ç›¸è«‡ï¼šæ‰‹å…¥åŠ›ï¼‰</option>
      `;
      other.disabled = false;
      shippingTitle.textContent = 'é‹é€æ®ä»˜ãƒ»ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—åŠã³è¬›ç¿’è²»ç”¨ï¼ˆå°‘æ•°é ­æ©Ÿï¼šè¨˜å…¥å¼ï¼‰';
    }else if(cat === 'sai'){
      // å½©ï¼šå½©å°‚ç”¨ã®é‹é€è²»
      region.innerHTML = `
        <option value="sai_kinki" selected>å½©ï¼šè¿‘ç•¿ï¼ˆ60,000å††ï¼‰</option>
        <option value="sai_chugoku">å½©ï¼šä¸­å›½ï¼ˆ90,000å††ï¼‰</option>
        <option value="sai_shikoku">å½©ï¼šå››å›½ï¼ˆ100,000å††ï¼‰</option>
        <option value="sai_kyushu">å½©ï¼šä¹å·ï¼ˆ130,000å††ï½160,000å††ï¼‰</option>
        <option value="other">ãã®ä»–ï¼ˆè¦ç›¸è«‡ï¼šæ‰‹å…¥åŠ›ï¼‰</option>
      `;
      other.disabled = true;
      shippingTitle.textContent = 'é‹é€æ®ä»˜ãƒ»ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—åŠã³è¬›ç¿’è²»ç”¨ï¼ˆå½©ï¼‰';
    }else{
      // å˜é ­æ©Ÿ
      region.innerHTML = `
        <option value="kinki" selected>å˜é ­æ©Ÿï¼šè¿‘ç•¿ï¼ˆ100,000å††ï¼‰</option>
        <option value="chugoku">å˜é ­æ©Ÿï¼šä¸­å›½ï¼ˆ130,000å††ï¼‰</option>
        <option value="shikoku">å˜é ­æ©Ÿï¼šå››å›½ï¼ˆ140,000å††ï¼‰</option>
        <option value="kyushu">å˜é ­æ©Ÿï¼šä¹å·ï¼ˆ170,000å††ï¼‰</option>
        <option value="other">ãã®ä»–ï¼ˆè¦ç›¸è«‡ï¼šæ‰‹å…¥åŠ›ï¼‰</option>
      `;
      other.disabled = true;
      shippingTitle.textContent = 'é‹é€æ®ä»˜ãƒ»ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—åŠã³è¬›ç¿’è²»ç”¨ï¼ˆå˜é ­æ©Ÿï¼‰';
    }
  }

  function updateNeedlesHeadsFields(){
    const cat = document.getElementById('machineCategory').value;
    const modelId = document.getElementById('machineModel').value;

    const needlesSel = document.getElementById('machineNeedles');
    const headsSel = document.getElementById('machineHeads');
    const fieldSel = document.getElementById('machineField');

    // è¡¨ç¤º/éè¡¨ç¤ºï¼ˆå½©ã¯å›ºå®šãªã®ã§éš ã™ï¼‰
    if(needlesSel?.parentElement) needlesSel.parentElement.style.display = (cat === 'sai') ? 'none' : '';
    if(headsSel?.parentElement)   headsSel.parentElement.style.display   = (cat === 'sai') ? 'none' : '';
    if(fieldSel?.parentElement)   fieldSel.parentElement.style.display   = (cat === 'sai') ? 'none' : '';

    needlesSel.innerHTML = '';
    headsSel.innerHTML = '';
    fieldSel.innerHTML = '';

    if(cat === 'sai'){
      // å›ºå®šå€¤ï¼ˆè¦‹ç©ç”Ÿæˆç”¨ã®å†…éƒ¨å€¤ï¼‰
      const optN = document.createElement('option');
      optN.value = '8';
      optN.textContent = '8é‡ï¼ˆå›ºå®šï¼‰';
      needlesSel.appendChild(optN);

      const optH = document.createElement('option');
      optH.value = '1';
      optH.textContent = '1é ­ï¼ˆå›ºå®šï¼‰';
      headsSel.appendChild(optH);

      const optF = document.createElement('option');
      optF.value = '200x300';
      optF.textContent = '200Ã—300ï¼ˆå›ºå®šï¼‰';
      fieldSel.appendChild(optF);
      return;
    }

    if(cat === 'single'){
      const m = SINGLE_SERIES.find(x=>x.id===modelId);
      (m?.needles || []).forEach((n,i)=>{
        const opt = document.createElement('option');
        opt.value = String(n);
        opt.textContent = `${n}é‡`;
        if(i===0) opt.selected = true;
        needlesSel.appendChild(opt);
      });

      // å˜é ­ï¼šé ­æ•°01å›ºå®š
      const h = document.createElement('option');
      h.value = '1';
      h.textContent = '1é ­';
      headsSel.appendChild(h);

      // å˜é ­ï¼š360x500å›ºå®š
      const f = document.createElement('option');
      f.value = '360x500';
      f.textContent = '360Ã—500';
      fieldSel.appendChild(f);
    }else{
      // å°‘æ•°é ­æ©Ÿ
      const m = FEW_MODELS.find(x=>x.id===modelId);
      (m?.needles || []).forEach((n,i)=>{
        const opt = document.createElement('option');
        opt.value = String(n);
        opt.textContent = `${n}é‡`;
        if(i===0) opt.selected = true;
        needlesSel.appendChild(opt);
      });

      (m?.heads || []).forEach((h,i)=>{
        const opt = document.createElement('option');
        opt.value = String(h);
        opt.textContent = `${h}é ­`;
        if(i===0) opt.selected = true;
        headsSel.appendChild(opt);
      });

      updateFieldOptions();
    }
  }

  function updateFieldOptions() {
    const cat = document.getElementById('machineCategory').value;
    if (cat !== 'few') return;

    const modelId = document.getElementById('machineModel').value;
    const heads = parseInt(document.getElementById('machineHeads').value || '2', 10);
    const fieldSel = document.getElementById('machineField');
    
    fieldSel.innerHTML = '';

    const m = FEW_MODELS.find(x => x.id === modelId);
    if (!m) return;

    // é ­æ•°ã«å¿œã˜ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é¸æŠè‚¢
    let availableFields = m.fields || [];
    if (m.fieldsByHeads && m.fieldsByHeads[heads]) {
      availableFields = m.fieldsByHeads[heads];
    }

    availableFields.forEach((v, i) => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = (v === '450x360') ? '450Ã—360' : '450Ã—500';
      if (i === 0) opt.selected = true;
      fieldSel.appendChild(opt);
    });
  }

  function getSelectedMachine(){
    const cat = document.getElementById('machineCategory').value;
    const modelId = document.getElementById('machineModel').value;
    const needles = parseInt(document.getElementById('machineNeedles').value || '0', 10);
    const heads = parseInt(document.getElementById('machineHeads').value || '1', 10);
    const field = document.getElementById('machineField').value;

    if(cat === 'sai'){
      const m = SAI_MODELS.find(x=>x.id===modelId) || SAI_MODELS[0];
      const modelKey = m.id;                 // PRICE_MASTERã‚­ãƒ¼
      const full = m.full || 'MDP-S0801C(200x300)S';
      return {
        category:'sai',
        modelKey,
        full,
        needles:8,
        heads:1,
        field:'200x300',
        displayName: m.displayName || 'TAJIMA å½©ï¼ˆSAIï¼‰'
      };
    }

    if(cat === 'single'){
      const m = SINGLE_SERIES.find(x=>x.id===modelId);
      // ä¾‹ï¼šTMBR2-S1501C(360x500)S
      const code = `${pad2(needles)}01`; // é‡æ•°+01
      const modelKey = `${modelId}${code}C`; // è¦‹ç©ç•ªå·ã«å…¥ã‚Œã‚‹ãƒ¢ãƒ‡ãƒ«å
      const full = `${modelId}${code}C(360x500)S`;
      return { 
        category:'single', 
        modelKey, 
        full, 
        needles, 
        heads:1, 
        field:'360x500',
        displayName: m?.displayName || 'ã‚¿ã‚¸ãƒåˆºç¹æ©Ÿ'
      };
    }else{
      const m = FEW_MODELS.find(x=>x.id===modelId);
      // ä¾‹ï¼šTMEZ-K1502C(450x500)S
      const code = `${pad2(needles)}${pad2(heads)}`;
      const fieldSuffix = (field === '450x500') ? '-500' : '';

      // ãƒ¢ãƒ‡ãƒ«ã‚­ãƒ¼ç”Ÿæˆ
      let modelKey;
      if (modelId === 'TFMX-2C') {
        // TFMX-2Cã¯ã€ŒTFMX-2C0602ã€å½¢å¼ï¼ˆCã‚’ä»˜ã‘ãªã„ï¼‰
        modelKey = `${modelId}${code}${fieldSuffix}`;
      } else {
        // TMAR-K / TMEZ-Kã¯ã€ŒTMAR-KC0902Cã€å½¢å¼
        let modelPrefix = modelId;
        if (modelId === 'TMAR-K') modelPrefix = 'TMAR-KC';
        if (modelId === 'TMEZ-K') modelPrefix = 'TMEZ-KC';
        modelKey = `${modelPrefix}${code}C${fieldSuffix}`;
      }

      const full = `${modelId}${code}C(${field})S`;
      return { 
        category:'few', 
        modelKey, 
        full, 
        needles, 
        heads, 
        field,
        displayName: m?.displayName || 'ã‚¿ã‚¸ãƒåˆºç¹æ©Ÿ'
      };
    }
  }

  function getMachineCodeForQuoteNo(){
    const m = getSelectedMachine();
    // è¦‹ç©ç•ªå·ç”¨ã¯åˆºç¹ç¯„å›²ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤ã
    if(m.category === 'few'){
      const code = `${pad2(m.needles)}${pad2(m.heads)}`;
      return `${m.modelKey.split('C')[0]}C`;
    }
    return m?.modelKey || 'MODEL';
  }

  function updateMachineOutputs(){
    const m = getSelectedMachine();
    const cat = document.getElementById('machineCategory')?.value || m.category || 'single';

    document.getElementById('machineFullOut').textContent = m.full;
    document.getElementById('machineKeyOut').textContent = getMachineCodeForQuoteNo();

    // ä¾¡æ ¼ãƒã‚¹ã‚¿ãŒã‚ã‚Œã°è‡ªå‹•ã‚»ãƒƒãƒˆ
    const unit = document.getElementById('baseUnitPrice');
    const masterPrice = PRICE_MASTER[m.modelKey];

    // å½©ï¼ˆSAIï¼‰ã¯æœ¬ä½“ä¾¡æ ¼ãŒå›ºå®šé‹ç”¨ã®ãŸã‚ã€åŒºåˆ†åˆ‡æ›¿æ™‚ã«ç¢ºå®Ÿã«åæ˜ ã•ã›ã‚‹
    if(cat === 'sai'){
      if(typeof masterPrice === 'number' && !Number.isNaN(masterPrice)){
        unit.value = String(masterPrice);
      }else{
        unit.value = '';
      }
      basePriceManuallyEdited = false; // å½©ã¯è‡ªå‹•åæ˜ ã‚’å„ªå…ˆï¼ˆå¿…è¦ãªã‚‰å¾Œã‹ã‚‰æ‰‹å…¥åŠ›ã§ä¸Šæ›¸ãå¯èƒ½ï¼‰
      return;
    }

    // å˜é ­æ©Ÿãƒ»å°‘æ•°é ­æ©Ÿï¼šæœªæ‰‹å…¥åŠ›ã®ã¨ãã®ã¿è‡ªå‹•åæ˜ 
    if(!basePriceManuallyEdited){
      if(typeof masterPrice === 'number' && !Number.isNaN(masterPrice)){
        unit.value = String(masterPrice);
      }else{
        unit.value = '';
      }
    }
  }

  function onMachineChanged(){
    updateMachineOutputs();
    updateOptionsList(); // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆæ›´æ–°
    const cat = document.getElementById('machineCategory')?.value || 'single';
    if(cat !== 'sai') renderTFAList(); // TFAæ å€™è£œæ›´æ–°ï¼ˆå½©ã¯éè¡¨ç¤ºï¼‰

    // è¦‹ç©ç•ªå·ï¼šæœªæ‰‹ç·¨é›†ãªã‚‰è‡ªå‹•æ›´æ–°ï¼ˆãƒ¢ãƒ‡ãƒ«åãŒå¤‰ã‚ã‚‹ãŸã‚ï¼‰
    updateQuoteNoIfAuto();
    applyAndRender();
  }

  function updateQuoteNoIfAuto(){
    if(typeof quoteNoManuallyEdited === 'undefined') return;
    if(!quoteNoManuallyEdited){
      const q = document.getElementById('quoteNo');
      q.value = generateQuoteNoNow();
    }
  }

  // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã“ã®ãƒ†ã‚¹ãƒˆç‰ˆã§ã¯ç„¡ã—
  function getSelectedOptions(){ 
    const options = [];
    const m = getSelectedMachine();

    // å½©ï¼ˆSAIï¼‰
    if(m.category === 'sai'){
      SAI_OPTIONS.forEach(opt=>{
        const el = document.getElementById(`opt_${opt.id}`);
        if(el && el.checked){
          const qty = parseInt(document.getElementById(`opt_${opt.id}_qty`)?.value || '1', 10);
          options.push({ name: opt.name, qty, unitPrice: opt.price, group:'machine' });
        }
      });

      // å½©å°‚ç”¨ï¼šã‚ã‚“ã—ã‚“å®šé¡ã‚µãƒãƒ¼ãƒˆï¼ˆ120,000å††ï¼‰
      const anshin = document.getElementById('opt_anshinSupport5y');
      if(anshin && anshin.checked){
        const qty = parseInt(document.getElementById('opt_anshinSupport5y_qty')?.value || '1', 10);
        options.push({ name: 'å®‰å¿ƒå®šé¡ã‚µãƒãƒ¼ãƒˆï¼ˆ5å¹´é–“ï¼‰', qty, unitPrice: 120000, group:'support' });
      }

      // å€¤å¼•ããƒ»ç‰¹åˆ¥å€¤å¼•ããƒ»ä¸‹å–ã‚Šãƒ»ãã®ä»–ã¯æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã«ä»»ã›ã‚‹ãŸã‚å¾Œæ®µã¸
    }

    // åŸåæ 
    const bffEl = document.getElementById('opt_bff');
    if (bffEl && bffEl.checked) {
      const bffType = document.getElementById('opt_bff_type')?.value || '';
      const price = getBFFPrice(m, bffType);
      const qty = parseInt(document.getElementById('opt_bff_qty')?.value || '1', 10);
      if (price > 0) {
        options.push({
          name: m.category === 'single' ? `åŸåæ ï¼ˆåŸåæ ç”¨å“ä»˜ãï¼‰${bffType}` : `åŸåæ  ${bffType}`,
          qty,
          unitPrice: price
        });
      }
    }
    
    // LEDç…§æ˜
    const ledEl = document.getElementById('opt_led');
    if (ledEl && ledEl.checked) {
      const price = getLEDPrice(m);
      const qty = parseInt(document.getElementById('opt_led_qty')?.value || '1', 10);
      if (price > 0) {
        const spec = m.category === 'single' ? '' : ` ${m.heads}H/${m.field === '450x360' ? '360' : '500'}å¯¾å¿œ`;
        options.push({
          name: `LEDç…§æ˜${spec}`,
          qty,
          unitPrice: price
        });
      }
    }
    
    // å¸½å­æ 
    const capEl = document.getElementById('opt_cap');
    if (capEl && capEl.checked) {
      const price = getCapFramePrice(m);
      const qty = parseInt(document.getElementById('opt_cap_qty')?.value || '1', 10);
      if (price > 0) {
        const spec = m.category === 'few' ? ` ${m.heads}H` : '';
        options.push({
          name: `å¸½å­æ ${spec}`,
          qty,
          unitPrice: price
        });
      }
    }
    
    // æ©Ÿç¨®é™å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆå˜é ­æ©Ÿã®ã¿ï¼‰
    if (m.category === 'single') {
      const modelId = document.getElementById('machineModel').value;
      const specificOpts = MODEL_SPECIFIC_OPTIONS[modelId];
      if (specificOpts) {
        specificOpts.forEach(opt => {
          const el = document.getElementById(`opt_${opt.id}`);
          if (el && el.checked) {
            const qty = parseInt(document.getElementById(`opt_${opt.id}_qty`)?.value || '1', 10);
            options.push({
          name: opt.name,
          qty,
          unitPrice: opt.price,
          group: opt.group
        });
          }
        });
      }
    }
    
    // å›ºå®šä¾¡æ ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆå½©ã®å ´åˆã¯anshinSupport5yã‚’é™¤å¤–ï¼‰
    FIXED_OPTIONS.forEach(opt => {
      // å½©ã®å ´åˆã€anshinSupport5yã¯æ—¢ã«ä¸Šã§120,000å††ã§å‡¦ç†æ¸ˆã¿ãªã®ã§ã‚¹ã‚­ãƒƒãƒ—
      if (m.category === 'sai' && opt.id === 'anshinSupport5y') {
        return;
      }
      
      const el = document.getElementById(`opt_${opt.id}`);
      if (el && el.checked) {
        const qty = parseInt(document.getElementById(`opt_${opt.id}_qty`)?.value || '1', 10);
        options.push({
          name: opt.name,
          qty,
          unitPrice: opt.price,
          group: opt.group
        });
      }
    });
    

// å€¤å¼•ãï¼ˆå¿…ãšãƒã‚¤ãƒŠã‚¹ã§è¨ˆä¸Šï¼‰
const discEl = document.getElementById('opt_discount');
if (discEl && discEl.checked) {
  const raw = parseInt(document.getElementById('opt_discount_amount')?.value || '0', 10);
  const amt = -Math.abs(Number.isFinite(raw) ? raw : 0);
  if (amt !== 0) {
    options.push({
      name: 'å€¤å¼•ã',
      qty: 1,
      unitPrice: amt,
      group: 'discount'
    });
  }
}

// ç‰¹åˆ¥å€¤å¼•ãï¼ˆå¿…ãšãƒã‚¤ãƒŠã‚¹ã§è¨ˆä¸Šï¼‰
const spEl = document.getElementById('opt_special_discount');
if (spEl && spEl.checked) {
  const raw = parseInt(document.getElementById('opt_special_discount_amount')?.value || '0', 10);
  const amt = -Math.abs(Number.isFinite(raw) ? raw : 0);
  if (amt !== 0) {
    options.push({
      name: 'ç‰¹åˆ¥å€¤å¼•ã',
      qty: 1,
      unitPrice: amt,
      group: 'specialDiscount'
    });
  }
}

// ä¸‹å–ã‚Šï¼ˆå¿…ãšãƒã‚¤ãƒŠã‚¹ã§è¨ˆä¸Šï¼‰
const tiEl = document.getElementById('opt_tradein');
if (tiEl && tiEl.checked) {
  const name = (document.getElementById('opt_tradein_name')?.value || '').trim();
  const raw = parseInt(document.getElementById('opt_tradein_amount')?.value || '0', 10);
  const amt = -Math.abs(Number.isFinite(raw) ? raw : 0);
  if (amt !== 0) {
    options.push({
      name: name ? `ä¸‹å–ã‚Šï¼š${name}` : 'ä¸‹å–ã‚Š',
      qty: 1,
      unitPrice: amt,
      group: 'tradeIn'
    });
  }
}


    // ãã®ä»–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆä»»æ„è¿½åŠ å¯¾å¿œï¼‰
    const otherBoxes = document.querySelectorAll('#optList input[type="checkbox"][id^="opt_other"]');
    otherBoxes.forEach(cb => {
      if (!cb.checked) return;
      const idx = parseInt(cb.id.replace('opt_other',''), 10);
      if (!Number.isFinite(idx)) return;

      const key = `other${idx}`;
      const name = document.getElementById(`opt_${key}_name`)?.value.trim() || `ãã®ä»–${idx}`;
      const price = parseInt(document.getElementById(`opt_${key}_price`)?.value || '0', 10);
      const qty = parseInt(document.getElementById(`opt_${key}_qty`)?.value || '1', 10);
      options.push({
        name,
        qty,
        unitPrice: Number.isFinite(price) ? price : 0,
        group: 'other'
      });
    });

    // æ—¢å­˜é …ç›®ã«groupãŒç„¡ã„å ´åˆã¯ machine æ‰±ã„
    options.forEach(o=>{ if(!o.group) o.group = 'machine'; });

    return options;
  }

  function getOptionModelBase(machine){
    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä¾¡æ ¼è¡¨ã®ã‚­ãƒ¼ã«åˆã‚ã›ã¦ãƒ¢ãƒ‡ãƒ«ç³»çµ±ã‚’æ­£è¦åŒ–
    // - TFMX-2C ã¯å‹å¼ä¸­ã«ã€Œ2ã€ãŒå«ã¾ã‚Œã‚‹ãŸã‚ split(/\d/) ã ã¨å´©ã‚Œã‚‹ã®ã§æ˜ç¤ºåˆ¤å®š
    // - TMEZ-KC ã¯ä¾¡æ ¼è¡¨å´ãŒã€ŒTMEZ-KCã€ã§ã¯ãªãã€ŒTMEZ-KC Type-2ãƒ»TMEZ-KCã€ã ãŒã€
    //   æœ¬ã‚³ãƒ¼ãƒ‰ã®ä¾¡æ ¼ãƒã‚¹ã‚¿ã¯ BFF_PRICES / LED_PRICES ã§ 'TMEZ-K' ã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚å¯„ã›ã‚‹
    if(machine.category === 'single') return 'SINGLE';
    const mk = String(machine.modelKey || '');
    if(mk.startsWith('TFMX-2C')) return 'TFMX-2C';
    if(mk.startsWith('TMAR-KC')) return 'TMAR-KC';
    if(mk.startsWith('TMEZ-KC')) return 'TMEZ-K';
    // å¿µã®ãŸã‚
    if(mk.startsWith('TMEZ-K')) return 'TMEZ-K';
    if(mk.startsWith('TMAR-K')) return 'TMAR-KC';
    return mk;
  }



  function getBFFPrice(machine, bffType) {
    if (machine.category === 'single') {
      return BFF_PRICES['SINGLE'][bffType] || 0;
    }
    const key = `${machine.heads}H-${machine.field === '450x360' ? '360' : '500'}`;
    const modelBase = getOptionModelBase(machine);
    const prices = BFF_PRICES[modelBase]?.[key];
    return prices?.[bffType] || 0;
  }

  function getLEDPrice(machine) {
    if (machine.category === 'single') {
      return LED_PRICES['SINGLE'];
    }
    const key = `${machine.heads}H-${machine.field === '450x360' ? '360' : '500'}`;
    const modelBase = getOptionModelBase(machine);
    return LED_PRICES[modelBase]?.[key] || 0;
  }

  function getCapFramePrice(machine) {
    if (machine.category === 'single') {
      return CAP_FRAME_PRICES['SINGLE'];
    }
    return CAP_FRAME_PRICES['FEW'][machine.heads] || 0;
  }

  function updateOptionsList() {
    const container = document.getElementById('optList');
    if (!container) return;

    // ã€Œãã®ä»–ã€å…¥åŠ›ã®çŠ¶æ…‹ã‚’ä¿æŒï¼ˆæ©Ÿç¨®åˆ‡æ›¿ãªã©ã§optListã‚’å†æç”»ã—ã¦ã‚‚ç¶­æŒï¼‰
    captureOtherState();

    container.innerHTML = '';
    const m = getSelectedMachine();
    const modelId = document.getElementById('machineModel').value;
    
    if (m.category === 'sai') {
      // å½©ï¼ˆSAIï¼‰ï¼šä¾¡æ ¼è¡¨PDFã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã¿ã‚’è¡¨ç¤ºï¼ˆTFA/DGã‚«ãƒ¼ãƒ‰ã¯éè¡¨ç¤ºï¼‰
      SAI_OPTIONS.forEach(opt => addSaiOption(container, opt));
      // å½©å°‚ç”¨ï¼šã‚ã‚“ã—ã‚“å®šé¡ã‚µãƒãƒ¼ãƒˆï¼ˆ120,000å††ï¼‰
      const saiSupport = { id: 'anshinSupport5y', name: 'å®‰å¿ƒå®šé¡ã‚µãƒãƒ¼ãƒˆï¼ˆ5å¹´é–“ï¼‰', price: 120000, group: 'support' };
      addFixedOption(container, saiSupport);
      // å€¤å¼•ã
      addDiscountOption(container);
      addSpecialDiscountOption(container);
      addTradeInOption(container);
      renderOtherOptions(container);
    } else if (m.category === 'single') {
      // å˜é ­æ©Ÿã®è¡¨ç¤ºé †
      addBFFOption(container, m);           // 1. åŸåæ 
      addCapFrameOption(container, m);       // 2. å¸½å­æ 
      addFixedOptionById(container, 'bagTable', m);         // 3. è¢‹ç‰©æ ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«
      addFixedOptionById(container, 'leg', m);              // 4. è„š
      addFixedOptionById(container, 'legTray', m);          // 5. è„šãƒˆãƒ¬ã‚¤
      addLEDOption(container, m);            // 6. LEDç…§æ˜
      addFixedOptionById(container, 'positionMarker', m);   // 7. ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚«ãƒ¼
      addFixedOptionById(container, 'bobbinWinder', m);     // 8. ä¸‹ç³¸å·»è£…ç½®
      addFixedOptionById(container, 'laserMarker', m);      // 9. ãƒ¬ãƒ¼ã‚¶ãƒ¼ã‚¯ãƒ­ã‚¹ãƒãƒ¼ã‚«ãƒ¼
      addFixedOptionById(container, 'sockFrameSet', m);     // 10. ã‚¿ã‚¸ãƒé´ä¸‹æ ã‚»ãƒƒãƒˆ
      addFixedOptionById(container, 'sockFrameSetMarusiki', m); // 11. ä¸¸æ­£å¼é´ä¸‹æ ã‚»ãƒƒãƒˆ
      addFixedOptionById(container, 'mFrameKit', m);        // 12. Mãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ã‚­ãƒƒãƒˆ
      addFixedOptionById(container, 'mClip50', m);          // 13. Mã‚¯ãƒªãƒƒãƒ—ï¼š50
      addFixedOptionById(container, 'mClip100', m);         // 14. Mã‚¯ãƒªãƒƒãƒ—ï¼š100
      addFixedOptionById(container, 'multiCode', m);        // 15. ãƒãƒ«ãƒã‚³ãƒ¼ãƒ‰è£…ç½®2
      
      
      // 17. æ©Ÿç¨®é™å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆESQ-Cã€ã‚·ãƒ¼ã‚¯ã‚¤ãƒ³â…£ï¼‰
      const specificOpts = MODEL_SPECIFIC_OPTIONS[modelId];
      if (specificOpts) {
        specificOpts.forEach(opt => {
          addModelSpecificOption(container, opt);
        });
      }
      addFixedOptionById(container, 'anshinSupport5y', m);  
      // 16 å®‰å¿ƒå®šé¡ã‚µãƒãƒ¼ãƒˆï¼ˆ5å¹´é–“ï¼‰
      // å€¤å¼•ã
      addDiscountOption(container);
      // ç‰¹åˆ¥å€¤å¼•ã / ä¸‹å–ã‚Š
      addSpecialDiscountOption(container);
      addTradeInOption(container);

      // æœ€å¾Œã«ã€Œãã®ä»–ã€ï¼ˆä»»æ„è¿½åŠ å¯¾å¿œï¼‰
      renderOtherOptions(container);
    } else {
      // å°‘æ•°é ­æ©Ÿã®è¡¨ç¤ºé †
      addBFFOption(container, m);            // 1. åŸåæ 
      addLEDOption(container, m);            // 2. LEDç…§æ˜
      addCapFrameOption(container, m);       // 3. å¸½å­æ 
      addFixedOptionById(container, 'positionMarker', m);   // 4. ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚«ãƒ¼
      addFixedOptionById(container, 'bobbinWinder', m);     // 5. ä¸‹ç³¸å·»è£…ç½®
      
      // å€¤å¼•ã
      addDiscountOption(container);
      // ç‰¹åˆ¥å€¤å¼•ã / ä¸‹å–ã‚Š
      addSpecialDiscountOption(container);
      addTradeInOption(container);

      // æœ€å¾Œã«ã€Œãã®ä»–ã€ï¼ˆä»»æ„è¿½åŠ å¯¾å¿œï¼‰
      renderOtherOptions(container);
    }
  }


  // =========================================================
  // ãã®ä»–ï¼ˆä»»æ„è¿½åŠ ï¼‰UI
  // =========================================================
  const OTHER_BASE_COUNT = 3;
  let otherDynamic = [];
  let otherDynamicNext = OTHER_BASE_COUNT + 1;
  let otherStateCache = {};

  function loadOtherDynamic(){
    try{
      otherDynamic = JSON.parse(localStorage.getItem('seiken_otherDynamic') || '[]')
        .map(n=>parseInt(n,10))
        .filter(n=>Number.isFinite(n) && n >= (OTHER_BASE_COUNT + 1));
    }catch(e){ otherDynamic = []; }

    try{
      const nxt = parseInt(localStorage.getItem('seiken_otherDynamicNext') || String(OTHER_BASE_COUNT + 1), 10);
      otherDynamicNext = (Number.isFinite(nxt) && nxt >= (OTHER_BASE_COUNT + 1)) ? nxt : (OTHER_BASE_COUNT + 1);
    }catch(e){
      otherDynamicNext = OTHER_BASE_COUNT + 1;
    }
  }

  function saveOtherDynamic(){
    try{
      localStorage.setItem('seiken_otherDynamic', JSON.stringify(otherDynamic));
      localStorage.setItem('seiken_otherDynamicNext', String(otherDynamicNext));
    }catch(e){}
  }

  function captureOtherState(){
    otherStateCache = {};
    try{
      const boxes = document.querySelectorAll('#optList input[type="checkbox"][id^="opt_other"]');
      boxes.forEach(cb=>{
        const idx = parseInt(cb.id.replace('opt_other',''), 10);
        if(!Number.isFinite(idx)) return;
        const key = `other${idx}`;
        otherStateCache[idx] = {
          checked: !!cb.checked,
          name: document.getElementById(`opt_${key}_name`)?.value ?? '',
          price: document.getElementById(`opt_${key}_price`)?.value ?? '',
          qty: document.getElementById(`opt_${key}_qty`)?.value ?? '1'
        };
      });
    }catch(e){}
  }

  function restoreOtherState(){
    try{
      Object.keys(otherStateCache).forEach(k=>{
        const idx = parseInt(k, 10);
        if(!Number.isFinite(idx)) return;
        const key = `other${idx}`;
        const st = otherStateCache[idx];

        const cb = document.getElementById(`opt_${key}`);
        if(cb) cb.checked = !!st.checked;

        const nm = document.getElementById(`opt_${key}_name`);
        const pr = document.getElementById(`opt_${key}_price`);
        const qty = document.getElementById(`opt_${key}_qty`);
        if(nm) nm.value = st.name ?? '';
        if(pr) pr.value = st.price ?? '';
        if(qty) qty.value = st.qty ?? '1';

        const row = document.getElementById(`row_${key}`);
        if(row && cb) row.className = cb.checked ? 'opt-row on' : 'opt-row off';
      });
    }catch(e){}
  }

  function addOtherDynamic(){
    const idx = otherDynamicNext;
    otherDynamicNext += 1;
    otherDynamic.push(idx);
    saveOtherDynamic();

    const container = document.getElementById('optList');
    if(!container) return;

    const addRow = document.getElementById('row_other_add');
    const div = addOtherOption(container, idx, true);
    if(addRow && div){
      container.insertBefore(div, addRow);
    }
    applyAndRender();
  }

  function removeOtherOption(idx){
    idx = parseInt(idx, 10);
    if(!Number.isFinite(idx)) return;

    otherDynamic = otherDynamic.filter(n => n !== idx);
    saveOtherDynamic();

    const row = document.getElementById(`row_other${idx}`);
    if(row) row.remove();

    applyAndRender();
  }

  function addOtherAddButtonRow(container){
    const div = document.createElement('div');
    div.className = 'opt-row off';
    div.id = 'row_other_add';
    div.style.justifyContent = 'flex-start';

    div.innerHTML = `
      <div style="width:44px;"></div>
      <div class="opt-label" style="flex:1;">
        <button class="btn mini" type="button" onclick="addOtherDynamic()">ï¼‹ãã®ä»–ã‚’è¿½åŠ </button>
        <span class="muted" style="margin-left:10px; font-size:12px;">å¿…è¦ãªåˆ†ã ã‘è¿½åŠ ã§ãã¾ã™ï¼ˆå¸³ç¥¨ã«ã¯é¸æŠã—ãŸé …ç›®ã®ã¿å‡ºåŠ›ï¼‰</span>
      </div>
    `;
    container.appendChild(div);
  }

  function renderOtherOptions(container){
    // å›ºå®š3æ 
    for(let i = 1; i <= OTHER_BASE_COUNT; i++){
      addOtherOption(container, i, false);
    }
    // è¿½åŠ åˆ†
    otherDynamic.forEach(idx => {
      addOtherOption(container, idx, true);
    });
    addOtherAddButtonRow(container);

    // ç›´å‰ã®å…¥åŠ›ã‚’å¾©å…ƒï¼ˆæ©Ÿç¨®åˆ‡æ›¿ç­‰ã§optListã‚’å†æç”»ã—ã¦ã‚‚å…¥åŠ›ã‚’ä¿æŒï¼‰
    restoreOtherState();
  }

function addDiscountOption(container) {
  const div = document.createElement('div');
  div.className = 'opt-row off';
  div.id = 'row_discount';

  div.innerHTML = `
    <label class="switch">
      <input type="checkbox" id="opt_discount" onchange="toggleOption('discount')">
      <span class="slider"></span>
    </label>
    <div class="opt-label" style="flex:1;">
      å€¤å¼•ã
      <span style="font-size:12px; color:#666; margin-left:6px;">ï¼ˆå…¥åŠ›ã—ãŸé‡‘é¡ã¯å¿…ãšãƒã‚¤ãƒŠã‚¹ã§è¡¨ç¤ºï¼‰</span>
      <span style="font-size:12px; color:#666; margin-left:10px;">é‡‘é¡ï¼š</span>
      <input type="number" id="opt_discount_amount" class="neg-input" placeholder="0" step="1000" style="width:140px; margin-left:4px;" oninput="applyAndRender()" />
    </div>
    <div class="muted" style="width:80px; text-align:right;">æ•°é‡ 1</div>
  `;

  container.appendChild(div);
}

function addSpecialDiscountOption(container) {
  const div = document.createElement('div');
  div.className = 'opt-row off';
  div.id = 'row_special_discount';

  div.innerHTML = `
    <label class="switch">
      <input type="checkbox" id="opt_special_discount" onchange="toggleOption('special_discount')">
      <span class="slider"></span>
    </label>
    <div class="opt-label" style="flex:1;">
      ç‰¹åˆ¥å€¤å¼•ã
      <span style="font-size:12px; color:#666; margin-left:6px;">ï¼ˆå…¥åŠ›ã—ãŸé‡‘é¡ã¯å¿…ãšãƒã‚¤ãƒŠã‚¹ã§è¡¨ç¤ºï¼‰</span>
      <span style="font-size:12px; color:#666; margin-left:10px;">é‡‘é¡ï¼š</span>
      <input type="number" id="opt_special_discount_amount" class="neg-input" placeholder="0" step="1000" style="width:140px; margin-left:4px;" oninput="applyAndRender()" />
    </div>
    <div class="muted" style="width:80px; text-align:right;">æ•°é‡ 1</div>
  `;

  container.appendChild(div);
}

function addTradeInOption(container) {
  const div = document.createElement('div');
  div.className = 'opt-row off';
  div.id = 'row_tradein';

  div.innerHTML = `
    <label class="switch">
      <input type="checkbox" id="opt_tradein" onchange="toggleOption('tradein')">
      <span class="slider"></span>
    </label>
    <div class="opt-label" style="flex:1;">
      ä¸‹å–ã‚Š
      <input type="text" id="opt_tradein_name" placeholder="å“åï¼ˆä¾‹ï¼šTMEF-612ï¼‰" style="width:200px; margin:0 8px;" oninput="applyAndRender()" />
      <span style="font-size:12px; color:#666;">é‡‘é¡ï¼š</span>
      <input type="number" id="opt_tradein_amount" class="neg-input" placeholder="0" step="1000" style="width:140px; margin:0 4px;" oninput="applyAndRender()" />
      <span style="font-size:12px; color:#666; margin-left:6px;">ï¼ˆå¿…ãšãƒã‚¤ãƒŠã‚¹ï¼‰</span>
    </div>
    <div class="muted" style="width:80px; text-align:right;">æ•°é‡ 1</div>
  `;

  container.appendChild(div);
}


    function addOtherOption(container, idx, removable) {
    removable = !!removable;
    const div = document.createElement('div');
    const key = `other${idx}`;
    div.className = 'opt-row off';
    div.id = `row_${key}`;

    const removeBtn = removable
      ? `<button class="btn mini" type="button" style="margin-left:8px" onclick="removeOtherOption(${idx})">å‰Šé™¤</button>`
      : '';

    div.innerHTML = `
      <label class="switch">
        <input type="checkbox" id="opt_${key}" onchange="toggleOption('${key}')">
        <span class="slider"></span>
      </label>
      <div class="opt-label" style="flex:1;">
        ãã®ä»–${idx}
        <input type="text" id="opt_${key}_name" placeholder="å“åï¼ˆä¾‹ï¼šè¿½åŠ æ ï¼‰" style="width:200px; margin:0 8px;" oninput="applyAndRender()" />
        <span style="font-size:12px; color:#666;">å˜ä¾¡ï¼š</span>
        <input type="number" id="opt_${key}_price" placeholder="0" step="1000" style="width:120px; margin:0 4px;" oninput="applyAndRender()" />
      </div>
      <input type="number" id="opt_${key}_qty" class="opt-qty" min="1" step="1" value="1" oninput="applyAndRender()" />
      ${removeBtn}
    `;

    container.appendChild(div);
    return div;
  }


  function addFixedOptionById(container, optId, machine) {
    const opt = FIXED_OPTIONS.find(o => o.id === optId);
    if (opt && opt.models.includes(machine.category)) {
      addFixedOption(container, opt);
    }
  }

  function addModelSpecificOption(container, opt) {
    const div = document.createElement('div');
    div.className = 'opt-row off';
    div.id = `row_${opt.id}`;
    
    div.innerHTML = `
      <label class="switch">
        <input type="checkbox" id="opt_${opt.id}" onchange="toggleOption('${opt.id}')">
        <span class="slider"></span>
      </label>
      <div class="opt-label">${opt.name} <span style="color:#666; font-size:12px;">${opt.price.toLocaleString()}</span></div>
      <input type="number" id="opt_${opt.id}_qty" class="opt-qty" min="1" step="1" value="1" oninput="applyAndRender()" />
    `;
    
    container.appendChild(div);
  }

  function addBFFOption(container, machine) {
    const div = document.createElement('div');
    div.className = 'opt-row off';
    div.id = 'row_bff';
    
    let selectHTML = '';
    let defaultType = '';
    
    if (machine.category === 'single') {
      // å˜é ­æ©Ÿï¼š2ç¨®é¡
      selectHTML = `
        <select id="opt_bff_type" style="width:140px; margin-left:8px;" onchange="onOptionChange('bff')">
          <option value="BFF3+BFF8">BFF3+BFF8</option>
          <option value="BFF2+BFF4">BFF2+BFF4</option>
        </select>
      `;
      defaultType = 'BFF3+BFF8';
    } else if (machine.modelKey.startsWith('TFMX-2C')) {
      // TFMX-2Cï¼šå›ºå®š
      selectHTML = '<span style="margin-left:8px; font-size:12px; color:#666;">(BFF2+BFF6 å›ºå®š)</span>';
      defaultType = 'BFF2+BFF6';
    } else {
      // TMAR-KC / TMEZ-KCï¼š3ç¨®é¡
      selectHTML = `
        <select id="opt_bff_type" style="width:140px; margin-left:8px;" onchange="onOptionChange('bff')">
          <option value="BFF3+BFF8">BFF3+BFF8</option>
          <option value="BFF2+BFF4">BFF2+BFF4</option>
          <option value="BFF2+BFF6">BFF2+BFF6</option>
        </select>
      `;
      defaultType = 'BFF3+BFF8';
    }
    
    const price = getBFFPrice(machine, defaultType);
    const labelText = machine.category === 'single' ? 'åŸåæ ï¼ˆåŸåæ ç”¨å“ä»˜ãï¼‰' : 'åŸåæ ';
    
    div.innerHTML = `
      <label class="switch">
        <input type="checkbox" id="opt_bff" onchange="toggleOption('bff')">
        <span class="slider"></span>
      </label>
      <div class="opt-label">${labelText}${selectHTML} <span style="color:#666; font-size:12px;">${price.toLocaleString()}</span></div>
      <input type="number" id="opt_bff_qty" class="opt-qty" min="1" step="1" value="1" oninput="applyAndRender()" />
    `;
    
    container.appendChild(div);
  }

  function addLEDOption(container, machine) {
    const div = document.createElement('div');
    div.className = 'opt-row off';
    div.id = 'row_led';
    
    const price = getLEDPrice(machine);
    const spec = machine.category === 'single' ? '' : ` (${machine.heads}H/${machine.field === '450x360' ? '360' : '500'}å¯¾å¿œ)`;
    
    div.innerHTML = `
      <label class="switch">
        <input type="checkbox" id="opt_led" onchange="toggleOption('led')">
        <span class="slider"></span>
      </label>
      <div class="opt-label">LEDç…§æ˜${spec} <span style="color:#666; font-size:12px;">${price.toLocaleString()}</span></div>
      <input type="number" id="opt_led_qty" class="opt-qty" min="1" step="1" value="1" oninput="applyAndRender()" />
    `;
    
    container.appendChild(div);
  }

  function addCapFrameOption(container, machine) {
    const div = document.createElement('div');
    div.className = 'opt-row off';
    div.id = 'row_cap';
    
    const price = getCapFramePrice(machine);
    const spec = machine.category === 'few' ? ` (${machine.heads}H)` : '';
    
    div.innerHTML = `
      <label class="switch">
        <input type="checkbox" id="opt_cap" onchange="toggleOption('cap')">
        <span class="slider"></span>
      </label>
      <div class="opt-label">å¸½å­æ ${spec} <span style="color:#666; font-size:12px;">${price.toLocaleString()}</span></div>
      <input type="number" id="opt_cap_qty" class="opt-qty" min="1" step="1" value="1" oninput="applyAndRender()" />
    `;
    
    container.appendChild(div);
  }

  function addFixedOption(container, opt) {
    const div = document.createElement('div');
    div.className = 'opt-row off';
    div.id = `row_${opt.id}`;
    
    div.innerHTML = `
      <label class="switch">
        <input type="checkbox" id="opt_${opt.id}" onchange="toggleOption('${opt.id}')">
        <span class="slider"></span>
      </label>
      <div class="opt-label">${opt.name} <span style="color:#666; font-size:12px;">${opt.price.toLocaleString()}</span></div>
      <input type="number" id="opt_${opt.id}_qty" class="opt-qty" min="1" step="1" value="1" oninput="applyAndRender()" />
    `;
    
    container.appendChild(div);
  }

  // å½©ï¼ˆSAIï¼‰ç”¨ï¼šã‚·ãƒ³ãƒ—ãƒ«ãªå›ºå®šä¾¡æ ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æç”»
  function addSaiOption(container, opt){
    addFixedOption(container, { id: opt.id, name: opt.name, price: opt.price });
  }


  function toggleOption(optId) {
    const row = document.getElementById(`row_${optId}`);
    const checkbox = document.getElementById(`opt_${optId}`);
    if (row && checkbox) {
      row.className = checkbox.checked ? 'opt-row on' : 'opt-row off';
    }
    applyAndRender();
  }

  function onOptionChange(optId) {
    // åŸåæ ã®ç¨®é¡å¤‰æ›´æ™‚ã«ä¾¡æ ¼ã‚’æ›´æ–°
    if (optId === 'bff') {
      const m = getSelectedMachine();
      const bffType = document.getElementById('opt_bff_type')?.value || '';
      const price = getBFFPrice(m, bffType);
      const row = document.getElementById('row_bff');
      if (row) {
        const priceSpan = row.querySelector('.opt-label span');
        if (priceSpan) {
          priceSpan.textContent = `${price.toLocaleString()}`;
        }
      }
    }
    applyAndRender();
  }

  function updateOptionSummary() {
    const summary = document.getElementById('optSummary');
    if (!summary) return;
    
    const opts = getSelectedOptions();
    const count = opts.length;
    const total = opts.reduce((sum, opt) => sum + (opt.unitPrice * opt.qty), 0);
    
    if (count === 0) {
      summary.textContent = '';
    } else {
      summary.textContent = `${count}é …ç›®é¸æŠä¸­ / åˆè¨ˆ ${total.toLocaleString()}`;
    }
  }

  // =========================================================
  // åˆºç¹ã‚½ãƒ•ãƒˆï¼ˆDGï¼‰UI
  // =========================================================
  function gradeIndex(gradeId){
    // DG-S ã¯æ¯”è¼ƒå¯¾è±¡å¤–ï¼ˆåˆ¥æ ï¼‰
    const order = ['EXPRESS','COMPOSER','CREATOR','ILLUSTRATOR_EXTREME','ARTIST_PLUS','MAESTRO'];
    return order.indexOf(gradeId);
  }

  function isGradeAtLeast(selectedId, minId){
    const s = gradeIndex(selectedId);
    const m = gradeIndex(minId);
    if(s < 0 || m < 0) return false;
    return s >= m;
  }

  function getSelectedDG(){
    const id = document.getElementById('dgGrade')?.value || '';
    if(!id) return null;
    return DG_SOFTWARE.find(x => x.id === id) || null;
  }

  function renderDGSelect(){
    const sel = document.getElementById('dgGrade');
    if(!sel) return;
    sel.innerHTML = '';
    const none = document.createElement('option');
    none.value = '';
    none.textContent = 'é¸æŠã—ãªã„';
    sel.appendChild(none);
    DG_SOFTWARE.forEach(s => {
      const o = document.createElement('option');
      o.value = s.id;
      o.textContent = `${s.name}${s.price ? `ï¼ˆ${s.price.toLocaleString()}ï¼‰` : ''}`;
      sel.appendChild(o);
    });
  }

  function renderDGToggleItem(container, item, prefix){
    const div = document.createElement('div');
    div.className = 'opt-row off';
    div.id = `${prefix}_row_${item.id}`;
    div.innerHTML = `
      <label class="switch">
        <input type="checkbox" id="${prefix}_${item.id}" onchange="toggleDGItem('${prefix}','${item.id}')">
        <span class="slider"></span>
      </label>
      <div class="opt-label">${item.name} <span style="color:#666; font-size:12px;">${item.price.toLocaleString()}</span></div>
      <input type="number" id="${prefix}_${item.id}_qty" class="opt-qty" min="1" step="1" value="1" oninput="applyAndRender()" />
    `;
    container.appendChild(div);
  }

  function toggleDGItem(prefix, itemId){
    const row = document.getElementById(`${prefix}_row_${itemId}`);
    const checkbox = document.getElementById(`${prefix}_${itemId}`);
    if(row && checkbox){
      row.className = checkbox.checked ? 'opt-row on' : 'opt-row off';
    }
    applyAndRender();
  }

  function clearDGSelections(prefix){
    const list = document.querySelectorAll(`[id^="${prefix}_row_"] input[type="checkbox"]`);
    list.forEach(cb => { cb.checked = false; });
    const rows = document.querySelectorAll(`[id^="${prefix}_row_"]`);
    rows.forEach(r => { r.className = 'opt-row off'; });
  }

  function renderDGLists(){
    const dg = getSelectedDG();

    const optPanel = document.getElementById('dgOptPanel');
    const fontPanel = document.getElementById('dgFontPanel');
    const lanPanel = document.getElementById('dgLanPanel');

    const optList = document.getElementById('dgOptList');
    const fontList = document.getElementById('dgFontList');
    const lanList = document.getElementById('dgLanList');
    const lessonRow = document.getElementById('dgopt_row_DG_LESSON');

    if(!optList || !fontList || !lanList) return;

    // æœªé¸æŠãªã‚‰å…¨éè¡¨ç¤º
    if(!dg){
      optPanel.style.display = 'none';
      fontPanel.style.display = 'none';
      lanPanel.style.display = 'none';
      optList.innerHTML = '';
      fontList.innerHTML = '';
      lanList.innerHTML = '';
      if(lessonRow) lessonRow.style.display = 'none';
      return;
    }

    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ãƒ•ã‚©ãƒ³ãƒˆ
    optPanel.style.display = dg.optionsEnabled ? '' : 'none';
    if(lessonRow) lessonRow.style.display = dg.optionsEnabled ? '' : 'none';
    if(!dg.optionsEnabled){
      const cbL = document.getElementById('dgopt_DG_LESSON');
      if(cbL) cbL.checked = false;
      if(lessonRow) lessonRow.className = 'opt-row off';
    }
    fontPanel.style.display = dg.fontsEnabled ? '' : 'none';

    optList.innerHTML = '';
    fontList.innerHTML = '';
    if(dg.optionsEnabled){
      DG_OPTIONS.filter(it => isGradeAtLeast(dg.id, it.minGrade)).forEach(it => renderDGToggleItem(optList, it, 'dgopt'));
    }
    if(dg.fontsEnabled){
      DG_FONTS.filter(it => isGradeAtLeast(dg.id, it.minGrade)).forEach(it => renderDGToggleItem(fontList, it, 'dgfont'));
    }

    // æ—§é¸æŠã‚’ã‚¯ãƒªã‚¢ï¼ˆã‚°ãƒ¬ãƒ¼ãƒ‰å¤‰ãˆã¦æ®‹ã‚‹äº‹æ•…é˜²æ­¢ï¼‰
    clearDGSelections('dgopt');
    clearDGSelections('dgfont');

    // LANï¼ˆãƒ«ãƒ¼ãƒ«ã«å¿œã˜ã¦å€™è£œåˆ‡æ›¿ï¼‰
    lanPanel.style.display = '';
    lanList.innerHTML = '';
    if(dg.lanRule === 'WP'){
      renderDGToggleItem(lanList, DG_LAN_LICENSES.WP, 'dglan');
    }else if(dg.lanRule === 'DG'){
      renderDGToggleItem(lanList, DG_LAN_LICENSES.DG, 'dglan');
    }
    clearDGSelections('dglan');

    updateDGSummary();
  }

  function getSelectedDGItems(prefix, master){
    const items = [];
    master.forEach(it => {
      const cb = document.getElementById(`${prefix}_${it.id}`);
      if(!cb || !cb.checked) return;
      const qtyEl = document.getElementById(`${prefix}_${it.id}_qty`);
      const qty = Math.max(1, parseInt(qtyEl?.value || '1', 10));
      items.push({ name: it.name, qty, unitPrice: it.price });
    });
    return items;
  }

  function getSelectedDGLan(dg){
    if(!dg) return [];
    const lan = (dg.lanRule === 'WP') ? DG_LAN_LICENSES.WP : DG_LAN_LICENSES.DG;
    const cb = document.getElementById(`dglan_${lan.id}`);
    if(!cb || !cb.checked) return [];
    const qtyEl = document.getElementById(`dglan_${lan.id}_qty`);
    const qty = Math.max(1, parseInt(qtyEl?.value || '1', 10));
    const name = lan.note ? `${lan.name}ï¼ˆ${lan.note}ï¼‰` : lan.name;
    return [{ name, qty, unitPrice: lan.price }];
  }

  function updateDGSummary(){
    const dg = getSelectedDG();
    const optS = document.getElementById('dgOptSummary');
    const fontS = document.getElementById('dgFontSummary');
    const lanS = document.getElementById('dgLanSummary');
    if(!dg){
      if(optS) optS.textContent = '';
      if(fontS) fontS.textContent = '';
      if(lanS) lanS.textContent = '';
      return;
    }

    const optItemsBase = dg.optionsEnabled ? getSelectedDGItems('dgopt', DG_OPTIONS.filter(it => isGradeAtLeast(dg.id, it.minGrade))) : [];
    const lessonItem = dg.optionsEnabled ? getSelectedDGLessonItem() : null;
    const optItems = lessonItem ? [lessonItem, ...optItemsBase] : optItemsBase;
    const fontItems = dg.fontsEnabled ? getSelectedDGItems('dgfont', DG_FONTS.filter(it => isGradeAtLeast(dg.id, it.minGrade))) : [];
    const lanItems = getSelectedDGLan(dg);

    const sum = arr => arr.reduce((s,it)=>s + (it.unitPrice* (Number(it.qty)||0)),0);

    if(optS) optS.textContent = optItems.length ? `${optItems.length}é …ç›® / åˆè¨ˆ ${sum(optItems).toLocaleString()}` : '';
    if(fontS) fontS.textContent = fontItems.length ? `${fontItems.length}é …ç›® / åˆè¨ˆ ${sum(fontItems).toLocaleString()}` : '';
    if(lanS)  lanS.textContent = lanItems.length ? `åˆè¨ˆ ${sum(lanItems).toLocaleString()}` : '';
  }

  function initDGSoftwareUI(){
    renderDGSelect();
    const sel = document.getElementById('dgGrade');
    if(sel){
      sel.addEventListener('change', ()=>{
        renderDGLists();
        applyAndRender();
      });
    }

    // åˆæœŸã¯éè¡¨ç¤º
    renderDGLists();

    // å„ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã¦ãŠãï¼ˆèµ·å‹•æ™‚ã‚¯ãƒ­ãƒ¼ã‚ºé‹ç”¨ï¼‰
    const optPanel = document.getElementById('dgOptPanel');
    const fontPanel = document.getElementById('dgFontPanel');
    const lanPanel = document.getElementById('dgLanPanel');
    if(optPanel) optPanel.open = false;
    if(fontPanel) fontPanel.open = false;
    if(lanPanel) lanPanel.open = false;
  }

  // BASE_ITEM / MODEL_LINES ã¯ buildLineItems å†…ã§å‹•çš„ç”Ÿæˆã—ã¾ã™
  function buildLineItems(){
    const lines = [];
    const m = getSelectedMachine();

    const baseQty = Math.max(1, parseInt(document.getElementById('baseQty').value || '1', 10));
    const unit = parseInt(document.getElementById('baseUnitPrice').value || '0', 10);

    // æœ¬ä½“
    const baseName = m.displayName;
    lines.push({ name: baseName, qty: baseQty, unitPrice: Number.isFinite(unit) ? unit : 0 });

    // å‹å¼
    lines.push({ name: `å‹å¼ï¼š${m.full}`, qty:'', unitPrice:'' });

    // å½©ã®æ¨™æº–ä»˜å±å“ï¼ˆå›ºå®šè¡¨ç¤ºï¼‰
    if(m.category === 'sai'){
      lines.push({ name: 'æ¨™æº–ä»˜å±ï¼šè¢‹ç‰©æ  200Ã—300ã€100Ã—100 å„1å€‹ä»˜', qty:'', unitPrice:'' });
      lines.push({ name: 'æ¨™æº–ä»˜å±ï¼šãƒ‡ãƒ¼ã‚¿ä½œæˆã‚½ãƒ•ãƒˆã€ŒWriterPlusã€', qty:'', unitPrice:'' });
      lines.push({ name: 'æ¨™æº–ä»˜å±ï¼šæ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆï¼ˆæ¥·æ›¸ä½“ã€å¤ªã‚´ã‚·ãƒƒã‚¯ä½“ï¼‰', qty:'', unitPrice:'' });
    }

    // æ©Ÿæ¢°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç¾¤
    const opts = getSelectedOptions();
    opts.filter(o=>o.group === 'machine').forEach(o=>{
      lines.push({ name:o.name, qty:o.qty, unitPrice:o.unitPrice });
    });

    // ãã®ä»–ï¼ˆä»»æ„ãƒ»ãƒ—ãƒ©ã‚¹ç³»ï¼‰ã‚‚ã€Œæ©Ÿæ¢°ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ‰±ã„ã€ã§ã€TFAæ ã‚ˆã‚Šä¸Šã«è¡¨ç¤º
    opts.filter(o=>o.group === 'other').forEach(o=>{
      lines.push({ name:o.name, qty:o.qty, unitPrice:o.unitPrice });
    });

    // åˆºç¹æ ï¼ˆTFA/TFA2ï¼‰ã¯å½©ã§ã¯éè¡¨ç¤º
    if(m.category !== 'sai'){
      // åˆºç¹æ ï¼ˆTFA/TFA2ï¼‰ã¯æ©Ÿæ¢°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆï¼‹ãã®ä»–ï¼‰ã®ç›´ä¸‹
      getSelectedTFAItems().forEach(it => lines.push(it));
    }

    // åˆºç¹ã‚½ãƒ•ãƒˆï¼ˆDGï¼‰ã¯å½©ã§ã‚‚è¡¨ç¤ºå¯èƒ½
    const dg = getSelectedDG();
    if(dg){
      const dgQty = Math.max(1, parseInt(document.getElementById('dgQty')?.value || '1', 10));
      lines.push({ name: `åˆºç¹ã‚½ãƒ•ãƒˆï¼š${dg.name}`, qty: dgQty, unitPrice: dg.price });

      if(dg.optionsEnabled){
        const optMaster = DG_OPTIONS.filter(it => isGradeAtLeast(dg.id, it.minGrade));
        const lesson = getSelectedDGLessonItem();
        if(lesson) lines.push(lesson);
        getSelectedDGItems('dgopt', optMaster).forEach(it => lines.push(it));
      }
      if(dg.fontsEnabled){
        const fontMaster = DG_FONTS.filter(it => isGradeAtLeast(dg.id, it.minGrade));
        getSelectedDGItems('dgfont', fontMaster).forEach(it => lines.push(it));
      }
      getSelectedDGLan(dg).forEach(it => lines.push(it));
    }

    // å®‰å¿ƒå®šé¡ã‚µãƒãƒ¼ãƒˆï¼ˆ5å¹´é–“ï¼‰ â€»å€¤å¼•ãã®ä¸Šã«è¡¨ç¤º
    opts.filter(o=>o.group === 'support').forEach(o=> lines.push({ name:o.name, qty:o.qty, unitPrice:o.unitPrice }));


    // å€¤å¼•ããƒ»ç‰¹åˆ¥å€¤å¼•ããƒ»ä¸‹å–ã‚Š
    opts.filter(o=>o.group === 'discount').forEach(o=> lines.push({ name:o.name, qty:o.qty, unitPrice:o.unitPrice }));
    opts.filter(o=>o.group === 'specialDiscount').forEach(o=> lines.push({ name:o.name, qty:o.qty, unitPrice:o.unitPrice }));
    opts.filter(o=>o.group === 'tradeIn').forEach(o=> lines.push({ name:o.name, qty:o.qty, unitPrice:o.unitPrice }));
    // é‹é€æ®ä»˜è²»
    lines.push(getRegionItem());

    return lines;
  }

  function getRegionItem(){
    const region = document.getElementById('region').value;
    const other = document.getElementById('regionOtherPrice');

    const cat = document.getElementById('machineCategory') ? document.getElementById('machineCategory').value : 'single';

    // å°‘æ•°é ­æ©Ÿã¯åŸºæœ¬ã€Œãã®ä»–ï¼ˆæ‰‹å…¥åŠ›ï¼‰ã€é‹ç”¨
    if(cat === 'few'){
      const val = Math.max(0, parseInt(other.value || '0', 10));
      return { name: 'é‹é€æ®ä»˜ãƒ»ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—åŠã³è¬›ç¿’è²»ç”¨ï¼ˆå°‘æ•°é ­æ©Ÿï¼‰', qty: 1, unitPrice: val };
    }

    // å½©ç”¨ã®é‹é€è²»ï¼ˆPDFã«åŸºã¥ãï¼‰
    const mapSai = { 
      sai_kinki: 60000,
      sai_chugoku: 90000,
      sai_shikoku: 100000,
      sai_kyushu: 145000  // 130,000ï½160,000å††ã®ä¸­é–“å€¤
    };
    
    // å˜é ­æ©Ÿç”¨ã®é‹é€è²»
    const mapSingle = { 
      kinki: 100000,
      chugoku: 130000,
      shikoku: 140000,
      kyushu: 170000
    };
    
    if(region === 'other'){
      const val = Math.max(0, parseInt(other.value || '0', 10));
      return { name: 'é‹é€æ®ä»˜ãƒ»ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—åŠã³è¬›ç¿’è²»ç”¨', qty: 1, unitPrice: val };
    }
    
    // å½©ã®åœ°åŸŸã‚’é¸æŠã—ãŸå ´åˆ
    if(region.startsWith('sai_')){
      return { name: 'é‹é€æ®ä»˜ãƒ»ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—åŠã³è¬›ç¿’è²»ç”¨ï¼ˆå½©ï¼‰', qty: 1, unitPrice: mapSai[region] ?? 0 };
    }
    
    // å˜é ­æ©Ÿã®åœ°åŸŸã‚’é¸æŠã—ãŸå ´åˆ
    return { name: 'é‹é€æ®ä»˜ãƒ»ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—åŠã³è¬›ç¿’è²»ç”¨', qty: 1, unitPrice: mapSingle[region] ?? 0 };
  }

  function buildToText(){
    const base = (document.getElementById('toBase').value || '').trim();
    const honor = document.getElementById('toHonorific').value;
    if(!base) return `æ ªå¼ä¼šç¤¾ã€€ï¼¿ï¼¿ï¼¿ï¼¿ã€€${honor}`;
    return `${base}ã€€${honor}`;
  }

  function onIssueDateChange(){
    applyAndRender();
  }

  const TAX_RATE = 0.10;

  function yen(n){
    if(!Number.isFinite(n)) return '0';
    const abs = Math.abs(n);
    const s = abs.toLocaleString('ja-JP');
    return s;
  }

  function formatReiwa(yyyymmdd){
    if(!yyyymmdd) return 'ä»¤å’Œ -- å¹´ -- æœˆ -- æ—¥';
    const [y, m, d] = yyyymmdd.split('-').map(Number);
    if(!y || !m || !d) return 'ä»¤å’Œ -- å¹´ -- æœˆ -- æ—¥';
    const reiwa = y - 2018;
    if(reiwa < 1) return `ä»¤å’Œ -- å¹´ ${m} æœˆ ${d} æ—¥`;
    return `ä»¤å’Œ ${reiwa} å¹´ ${m} æœˆ ${d} æ—¥`;
  }

  function applyAndRender(){
    updateTFASummary();
    const regionEl = document.getElementById('region');
    const other = document.getElementById('regionOtherPrice');
    const cat = document.getElementById('machineCategory') ? document.getElementById('machineCategory').value : 'single';

    // å°‘æ•°é ­æ©Ÿã¯åŸºæœ¬ã€Œãã®ä»–ï¼ˆæ‰‹å…¥åŠ›ï¼‰ã€é‹ç”¨
    if(cat === 'few'){
      if(regionEl.value !== 'other') regionEl.value = 'other';
      other.disabled = false;
    }else{
      other.disabled = regionEl.value !== 'other';
    }

    const region = regionEl.value;

    // åˆºç¹ã‚½ãƒ•ãƒˆï¼ˆDGï¼‰ã‚µãƒãƒªãƒ¼æ›´æ–°
    updateDGSummary();

    const quoteNo = (document.getElementById('quoteNo').value || '').trim() || `--${getMachineCodeForQuoteNo() || DEFAULT_MACHINE_CODE}----------`;
    const issueDate = document.getElementById('issueDate').value;

    const delivery = document.getElementById('delivery').value.trim() || 'å—æ³¨å¾Œ ç´„3ã‚«æœˆ';
    const place = buildPlaceText();
    const payment = document.getElementById('payment').value.trim() || 'ç´å…¥æ™‚ ç¾é‡‘ä¸€æ‹¬æ‰•ã„';
    const valid = document.getElementById('valid').value.trim() || '30æ—¥';

    const notes = document.getElementById('notes').value.trim() || '';
    const tantou = document.getElementById('tantouSelect').value;

    document.getElementById('outTo').textContent = buildToText();
    document.getElementById('outNo').textContent = `No.${quoteNo}`;
    document.getElementById('outDate').textContent = formatReiwa(issueDate);

    document.getElementById('outDelivery').textContent = delivery;
    document.getElementById('outPlace').textContent = place;
    document.getElementById('outPayment').textContent = payment;
    document.getElementById('outValid').textContent = valid;

    document.getElementById('outTantou').textContent = `æ‹…å½“è€…ã€€${tantou || 'ï¼¿ï¼¿ï¼¿ï¼¿'}`;
    document.getElementById('outNotes').textContent = notes;
    
    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚µãƒãƒªãƒ¼æ›´æ–°
    updateOptionSummary();

    const lines = buildLineItems();
    const tbody = document.getElementById('outItems');
    tbody.innerHTML = '';

    let subtotal = 0;

    lines.forEach(li=>{
      const tr = document.createElement('tr');

      const tdDesc = document.createElement('td');
      tdDesc.className='desc';
      tdDesc.textContent = li.name;

      const tdQty = document.createElement('td');
      tdQty.className='c-qty';
      tdQty.textContent = li.qty;

      const tdUnit = document.createElement('td');
      tdUnit.className='c-unit';

      const tdAmt = document.createElement('td');
      tdAmt.className='c-amt';

      if(typeof li.unitPrice === 'number'){
        tdUnit.textContent = yen(li.unitPrice);
        const qty = (typeof li.qty === 'number') ? li.qty : 1;
        const amt = li.unitPrice * qty;
        tdAmt.textContent = yen(amt);
        if(li.unitPrice < 0) tdUnit.classList.add('neg');
        if(amt < 0) tdAmt.classList.add('neg');
        subtotal += amt;
      }else{
        tdUnit.textContent = '';
        tdAmt.textContent = '';
      }

      tr.appendChild(tdDesc);
      tr.appendChild(tdQty);
      tr.appendChild(tdUnit);
      tr.appendChild(tdAmt);
      tbody.appendChild(tr);
    });

    const tax = Math.round(subtotal * TAX_RATE);
    const total = subtotal + tax;

    {
      const elSub = document.getElementById('outSub');
      const elTax = document.getElementById('outTax');
      const elTotal = document.getElementById('outTotal');
      const elGrand = document.getElementById('outGrand');

      elSub.textContent = yen(subtotal);
      elTax.textContent = yen(tax);
      elTotal.textContent = yen(total);
      elGrand.textContent = `ï¿¥${yen(total)} -`;

      // ãƒã‚¤ãƒŠã‚¹ã¯ã€Œç¬¦å·ãªã—ï¼‹èµ¤å­—ã€ã§è¡¨ç¾
      elSub.classList.toggle('neg', subtotal < 0);
      elTax.classList.toggle('neg', tax < 0);
      elTotal.classList.toggle('neg', total < 0);
      elGrand.classList.toggle('neg', total < 0);
    }

    updateOptionSummary();
  }
  // === è¿½åŠ ï¼šã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ¥ãƒªã‚»ãƒƒãƒˆ ===
  function resetBasicInfoSection(){
    const today = new Date();
    const issueDate = document.getElementById('issueDate');
    if(issueDate) issueDate.valueAsDate = today;

    const setVal = (id,val)=>{ const el=document.getElementById(id); if(el) el.value = val; };

    setVal('toBase','');
    setVal('toHonorific','å¾¡ä¸­');
    setVal('tantouSelect','');

    setVal('delivery','å—æ³¨å¾Œ ç´„3ã‚«æœˆ');

    // å—æ¸¡å ´æ‰€ï¼ˆä½æ‰€ï¼‰
    setVal('zip','');
    setVal('pref','');
    setVal('city','');
    setVal('town','');
    setVal('addr2','');

    setVal('payment','ç´å…¥æ™‚ ç¾é‡‘ä¸€æ‹¬æ‰•ã„');
    setVal('valid','30æ—¥');
    setVal('notes','');

    // è¦‹ç©ç•ªå·ã¯è§¦ã‚‰ãªã„ï¼ˆå¿…è¦ãªã‚‰ãƒ˜ãƒƒãƒ€ãƒ¼ã®å†ç”Ÿæˆãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ï¼‰
    applyAndRender();
  }

  function resetMachineSection(){
    // æœ¬ä½“ãƒ»é‹é€è²»ãƒ»æœ¬ä½“ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã¿åˆæœŸåŒ–
    basePriceManuallyEdited = false;

    const cat = document.getElementById('machineCategory');
    if(cat) cat.value = 'single';
    updateMachineSelectors();

    const setVal = (id,val)=>{ const el=document.getElementById(id); if(el) el.value = val; };
    setVal('baseQty', 1);
    setVal('baseUnitPrice','');

    // æœ¬ä½“ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    resetAllOptions();

    // é‹é€è²»
    const region = document.getElementById('region');
    if(region) region.value = 'kinki';
    const other = document.getElementById('regionOtherPrice');
    if(other){ other.value=''; other.disabled=true; }

    applyAndRender();
  }

  function resetSoftwareSection(){
    if(typeof resetDGSoftware === 'function') resetDGSoftware();
    applyAndRender();
  }

  function resetAll(){
    const today = new Date();
    document.getElementById('issueDate').valueAsDate = today;

    document.getElementById('toBase').value = '';
    document.getElementById('toHonorific').value = 'å¾¡ä¸­';
    document.getElementById('tantouSelect').value = '';

    // æ©Ÿç¨®é¸æŠï¼ˆåˆæœŸå€¤ï¼‰
    basePriceManuallyEdited = false;
    document.getElementById('machineCategory').value = 'single';
    updateMachineSelectors();

    document.getElementById('baseQty').value = 1;
    document.getElementById('baseUnitPrice').value = '';

    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ãƒªã‚»ãƒƒãƒˆ
    resetAllOptions();

    // åˆºç¹ã‚½ãƒ•ãƒˆï¼ˆDGï¼‰ã®ãƒªã‚»ãƒƒãƒˆ
    if(typeof resetDGSoftware === "function") resetDGSoftware();

    // åˆºç¹æ ï¼ˆTFA/TFA2ï¼‰ã®ãƒªã‚»ãƒƒãƒˆ
    if(typeof resetTFASection === "function") resetTFASection();


    // é‹é€è²»
    document.getElementById('region').value = 'kinki';
    document.getElementById('regionOtherPrice').value = '';
    document.getElementById('regionOtherPrice').disabled = true;

    // æ¡ä»¶
    document.getElementById('delivery').value = 'å—æ³¨å¾Œ ç´„3ã‚«æœˆ';
    document.getElementById('zip').value = '';
    document.getElementById('pref').value = '';
    document.getElementById('city').value = '';
    document.getElementById('town').value = '';
    document.getElementById('addr2').value = '';
    document.getElementById('payment').value = 'ç´å…¥æ™‚ ç¾é‡‘ä¸€æ‹¬æ‰•ã„';
    document.getElementById('valid').value = '30æ—¥';

    document.getElementById('notes').value = '';

    // è¦‹ç©ç•ªå·ï¼šãƒªã‚»ãƒƒãƒˆæ™‚ã¯è‡ªå‹•ç”Ÿæˆã«ã™ã‚‹
    quoteNoManuallyEdited = false;
    document.getElementById('quoteNo').value = generateQuoteNoNow();

    applyAndRender();
  }

  function resetAllOptions() {
    // å…¨ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™
    const checkboxes = document.querySelectorAll('#optList input[type="checkbox"]');
    checkboxes.forEach(cb => {
      cb.checked = false;
      const row = cb.closest('.opt-row');
      if (row) row.className = 'opt-row off';
    });
    
    // å…¨ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æ•°é‡ã‚’1ã«ãƒªã‚»ãƒƒãƒˆ
    const qtyInputs = document.querySelectorAll('#optList .opt-qty');
    qtyInputs.forEach(input => {
      input.value = '1';
    });
    
    // åŸåæ ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
    const bffType = document.getElementById('opt_bff_type');
    if (bffType) bffType.selectedIndex = 0;
    

// å€¤å¼•ãã‚’ãƒªã‚»ãƒƒãƒˆ
const discAmt = document.getElementById('opt_discount_amount');
if (discAmt) discAmt.value = '';

// ãã®ä»–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆä»»æ„è¿½åŠ å¯¾å¿œï¼‰ã‚’ãƒªã‚»ãƒƒãƒˆ
const otherBoxesReset = document.querySelectorAll('#optList input[type="checkbox"][id^="opt_other"]');
otherBoxesReset.forEach(cb=>{
  const idx = parseInt(cb.id.replace('opt_other',''), 10);
  if(!Number.isFinite(idx)) return;
  const key = `other${idx}`;
  const nm = document.getElementById(`opt_${key}_name`);
  const pr = document.getElementById(`opt_${key}_price`);
  if(nm) nm.value = '';
  if(pr) pr.value = '';
});

// è¿½åŠ åˆ†ã¯åˆæœŸåŒ–ï¼ˆ3æ ã«æˆ»ã™ï¼‰
otherDynamic = [];
otherDynamicNext = OTHER_BASE_COUNT + 1;
saveOtherDynamic();
updateOptionsList();
    // ã‚µãƒãƒªãƒ¼ã‚’ã‚¯ãƒªã‚¢
    updateOptionSummary();
  }

  // === è¿½åŠ ï¼šåˆºç¹ã‚½ãƒ•ãƒˆï¼ˆDGï¼‰ã‚’ä¸€æ‹¬ãƒªã‚»ãƒƒãƒˆ ===
  function resetDGSoftware(){
    const grade = document.getElementById("dgGrade");
    const qty = document.getElementById("dgQty");

    if(qty) qty.value = "1";

    if(grade){
      grade.value = "";
    }

    // ä¸€æ—¦ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ï¼ˆæ®‹å­˜DOMãŒã‚ã‚‹å ´åˆã®å®‰å…¨ç­–ï¼‰
    ["dgopt","dgfont","dglan"].forEach(prefix=>{
      try{
        clearDGSelections(prefix);
      }catch(e){}
    });

    // ãƒªã‚¹ãƒˆã‚’å†æç”»ï¼ˆæœªé¸æŠï¼å…¨éè¡¨ç¤ºï¼‰
    try{
      renderDGLists();
    }catch(e){}

    // DGè¬›ç¿’è²»ç”¨ï¼ˆå…¥åŠ›å¼ï¼‰ã‚’ãƒªã‚»ãƒƒãƒˆ
    const lcb = document.getElementById('dgopt_DG_LESSON');
    const lprice = document.getElementById('dgopt_DG_LESSON_price');
    const lqty = document.getElementById('dgopt_DG_LESSON_qty');
    if(lcb) lcb.checked = false;
    if(lprice) lprice.value = '0';
    if(lqty) lqty.value = '1';
    const lrow = document.getElementById('dgopt_row_DG_LESSON');
    if(lrow) lrow.className = 'opt-row off';

    // ãƒ‘ãƒãƒ«ã¯é–‰ã˜ã¦ãŠã
    const optPanel = document.getElementById("dgOptPanel");
    const fontPanel = document.getElementById("dgFontPanel");
    const lanPanel = document.getElementById("dgLanPanel");
    if(optPanel) optPanel.open = false;
    if(fontPanel) fontPanel.open = false;
    if(lanPanel) lanPanel.open = false;

    // ã‚µãƒãƒªãƒ¼è¡¨ç¤ºã‚’æ¶ˆã™
    try{
      updateDGSummary();
    }catch(e){}
  }


  // ===== åˆæœŸåŒ– =====
  window.addEventListener('DOMContentLoaded', ()=>{
    const today = new Date();
    document.getElementById('issueDate').valueAsDate = today;
    document.getElementById('delivery').value = 'å—æ³¨å¾Œ ç´„3ã‚«æœˆ';
    document.getElementById('payment').value = 'ç´å…¥æ™‚ ç¾é‡‘ä¸€æ‹¬æ‰•ã„';
    document.getElementById('valid').value = '30æ—¥';

    loadOtherDynamic();
    initMachineUI();

    // åˆºç¹ã‚½ãƒ•ãƒˆï¼ˆDGï¼‰
    initDGSoftwareUI();

    // åˆå›è¦‹ç©ç•ªå·ç”Ÿæˆ
    document.getElementById('quoteNo').value = generateQuoteNoNow();

    applyAndRender();
  });
</script>
</body>
</html>